[<div class="wiki-body gollum-markdown-content instapaper_body" id="wiki-body">
        <div class="markdown-body">
          <p>The Search API is used to pull in data of different types - individual data records, plate maps, saved searches etc. - allowing these processes to use a common architecture.</p>
<p>At a basic level, the search API follows the pattern that a request is passed to an Angular controller, this optionally uses service classes to add parameters to the search depending on what it's being used for, and this then calls a Django web service. Results are retrieved from an elasticsearch instance, returned to the controller for further processing if required, then finally back to the browser for display.</p>
<p><img alt="Generic Search flowchart" src="https://github.com/thesgc/chembiohub_ws/raw/master/wiki-images/flow_chart_search_generic.png"/></p>
<h3>
<a aria-hidden="true" class="anchor" href="#anatomy-of-the-search-page" id="user-content-anatomy-of-the-search-page"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Anatomy of the search page</h3>
<p>The main search page for the application uses this generic methodology and utilises a number of extra services in order to make the page function - this includes pulling in parameters from the URL and ensuring search breadcrumbs and filtered are indicated correctly.</p>
<p><img alt="Main Search flowchart" src="https://github.com/thesgc/chembiohub_ws/raw/master/wiki-images/flow_chart_search_advanced.png"/></p>
<p>The services utilised are:</p>
<h3>
<a aria-hidden="true" class="anchor" href="#project-selector" id="user-content-project-selector"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Project selector</h3>
<p>The project selector is to the top left of the search page, this selects a set of project ids over which the search will be run. As the data is indexed on a per project basis, this list of projects is translated to a list of indices over which the search will be run.</p>
<h3>
<a aria-hidden="true" class="anchor" href="#text-search" id="user-content-text-search"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Text Search</h3>
<p>The Text search box is instant search, base 64 encoding is used in the GET request for the URL. The text search is then run across all projects and all fields. The logic used is from the <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-match-query.html#query-dsl-match-query-phrase-prefix" rel="nofollow">Elasticsearch phrase prefix query</a>.</p>
<h3>
<a aria-hidden="true" class="anchor" href="#sorting" id="user-content-sorting"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Sorting</h3>
<p>Users of ChemBio Hub have requested that they are able to still sort their data even if there is a mixture of strings and numbers in the field. This is acheived using elasticsearch regular expressions to zeropad any numbers in the index representation. This has the effect that anything can be sorted and go into numeric order first followed by alphabetical order.</p>
<h3>
<a aria-hidden="true" class="anchor" href="#advanced-search-forms" id="user-content-advanced-search-forms"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Advanced Search Forms</h3>
<p>The new ChemBio Hub Search API is designed to allow any list of JSON objects to be indexed and searched.</p>
<p>Data is indexed by passing a <a href="https://github.com/thesgc/chembiohub_ws/blob/master/cbh_utils/elasticsearch_client.py#L235">list of JSON objects and a schema per row</a>.</p>
<p>A search form is built, again using angular schema form (<a href="https://github.com/thesgc/chembiohub_ws/search?utf8=%E2%9C%93&amp;q=CBH_QUERY_SCHEMAFORM">see schema in the django settings</a>) which gives a set of search options for each field in the dataset. This looks like this in the front end:</p>
<p><img alt="" src="https://raw.githubusercontent.com/thesgc/chembiohub_ws/master/scripts/archive/Screenshot%20from%202016-04-13%2011%3A44%3A16.png"/></p>
<h3>
<a aria-hidden="true" class="anchor" href="#encoded-query" id="user-content-encoded-query"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Encoded query</h3>
<p>This set of forms, one per field are monitored for changes by the angular app. When a change occurs, a list of JSON objects are sent to the back end encoded in base 64.</p>
<p>The encoding ensures that the API url can represent the given search and that the search arrives at the back end intact without being split due to particular characters such as semicolons.</p>
<p>for further information see the <a class="internal present" href="/thesgc/chembiohub_ws/wiki/Search-and-Sort-JSON-Format">Search and Sort JSON Format</a></p>
<h3>
<a aria-hidden="true" class="anchor" href="#pick-from-list-query" id="user-content-pick-from-list-query"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Pick from list query</h3>
<p>The pick from list query uses a <a href="https://github.com/thesgc/ng-chem/blob/master/app/scripts/cbh_angular_schema_form_extension.js#L92">widget specially designed for ChemBio Hub</a>, modelled on the github label interface for issues.</p>
<p>This widget allows autocomplete data to be brought back from the backend based on what the user searches for. If more than 1000 results are returned then only the first 1000 are shown. The rest of the results can be accessed by searching.</p>
<h3>
<a aria-hidden="true" class="anchor" href="#search-page-uris" id="user-content-search-page-uris"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Search page URIs</h3>
<p>The search page URI contains all of the information needed to rebuild that search. This building and rebuilding of the search page URI is the task of the <a href="https://github.com/thesgc/ng-chem/blob/master/app/scripts/services/searchurlparamsv2.js">searchurlparamsv2</a> file.</p>
<h3>
<a aria-hidden="true" class="anchor" href="#saved-searches" id="user-content-saved-searches"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Saved searches</h3>
<p>Saved searches work as follows:</p>
<ol>
<li>A ProjectType must exist with saved_search_project_type=True</li>
<li>
<a href="https://github.com/thesgc/ng-chem/blob/master/app/scripts/controllers/searchv2.js#L212">A project is created using this project type to save the search in</a> (this is done as a container for permissions purposes)</li>
<li>
<a href="https://github.com/thesgc/ng-chem/blob/master/app/scripts/controllers/searchv2.js#L215">The search is saved as a compound batch</a> via the <a href="https://github.com/thesgc/chembiohub_ws/blob/master/cbh_chem_api/resources.py#L520">saved search api</a>.</li>
<li>The saved searches are then listed via the same API when the user clicks on <a href="https://github.com/thesgc/ng-chem/blob/master/app/scripts/controllers/searchv2.js#L132">show saved searches</a>
</li>
</ol>

        </div>

    </div>]