[<div class="wiki-body gollum-markdown-content instapaper_body" id="wiki-body">
        <div class="markdown-body">
          <p>This API does not expose standard GET/POST/PATCH methods but it is used instead to ensure that data is serialized in the correct format when saved to elasticsearch.</p>
<p>The entry point function is <a href="https://github.com/thesgc/chembiohub_ws/blob/master/cbh_chem_api/resources.py#L799">index_batches_in_new_index</a> This takes a list of compound batch or inventory objects and serializes them to JSON.</p>
<p><strong>Tests</strong></p>
<pre><code>This API is only tested as part of the end to end testing of the [[Bulk upload API]] and the [[Compound Batch API]].
</code></pre>
<p><strong>Optimisations</strong></p>
<p>In order to reduce the number of SQL queries when indexing large datasets, the projectfull and userfull fields are retrieved by generating a JSON dataset before the indexing process begins.</p>
<p><strong>Indexing to Elasticsearch</strong></p>
<p>The elasticsearch client used in indexing the compound batches accepts a list of JSON objects and a schema per object in the list. Eaxmple usage of this function is described in the below python code.</p>
<p>Note that the fields that are going to be indexed are configured in the global fields configuration which is partly done in the django settings added to with one schema record per item in that project.</p>
<pre><code>        batches = [{'bigimage': u'iVBORw0KGgoAAAANSUhEUgAAAyAAAAMgCAYAA',
          'blinded_batch_id': u'',
          'canonical_smiles': u'c1ccccc1',
          'created': '2016-05-09T06:00:22.221481',
          'created_by': u'superuser',
          'created_by_id': 2,
          ...,
          'userfull': {u'can_create_and_own_projects': True,
                       u'can_view_assayreg': True,
                       u'can_view_chemreg': True,
                       u'date_joined': u'2016-05-03T04:50:18.028509',
                       u'display_name': u'superuser',
                       u'first_name': u'',
                       u'id': 2,
                       u'is_logged_in': False,
                       u'is_staff': True,
                       u'is_superuser': True,
                       u'last_login': u'2016-05-09T05:59:49.576243',
                       u'last_name': u'',
                       u'resource_uri': u'/dev/api/users/2',
                       u'username': u'superuser'},
          'uuid': u'CBHVU79DCX',
          'warnings': {u'duplicate': u'true', u'new': u'true'}}]

        schemata = [[{u'className': u'htCenter htMiddle ',
           u'data': u'project_counter',
           u'editable': False,
           u'knownBy': u'ID in project'},
          {u'className': u' htCenter htMiddle ',
           u'data': u'uuid',
           u'editable': False,
           u'knownBy': u'CBH_ID',
           u'noSort': True,
           u'renderer_named': u'modalLinkRenderer',
           u'searchFormType': u'pick_from_list'},
          {u'className': u'htCenter htMiddle ',
           u'data': u'projectfull.name',
           u'editable': False,
           u'knownBy': u'Project',
           u'renderer_named': u'projectRenderer',
           u'searchFormType': u'default'},
          {u'className': u'htCenter htMiddle ',
           u'data': u'properties.archived',
           u'editable': True,
           u'knownBy': u'Archive',
           u'noSort': True,
           u'renderer_named': u'archivedRenderer',
           u'searchFormType': u'pick_from_list'},
          {u'className': u'htCenter htMiddle ',
           u'data': u'projectfull.project_type.saved_search_project_type',
           u'editable': False,
           u'knownBy': u'Is a saved search',
           u'noSort': True,
           u'renderer_named': u'archivedRenderer',
           u'searchFormType': u'pick_from_list'},
          {u'className': u'htCenter htMiddle ',
           u'data': u'custom_fields.Test Field',
           u'editable': True,
           u'editor': False,
           u'knownBy': u'Test Field',
           u'project_specific_schema': {u'12': {u'field_type': u'char',
                                                u'open_or_restricted': u'open',
                                                u'renderer_named': u'defaultCustomFieldRenderer'}},
           u'projects': [],
           u'renderer_named': u'customFieldRenderer'},
          {u'className': u'htCenter htMiddle ',
           u'data': u'userfull.display_name',
           u'editable': False,
           u'knownBy': u'Added By',
           u'noSort': True,
           u'searchFormType': u'pick_from_list'},
          {u'className': u'htCenter htMiddle ',
           u'data': u'timestamp',
           u'editable': False,
           u'field_type': u'date',
           u'knownBy': u'Date',
           u'noSort': True,
           u'searchFormType': u'date_range'},
          {u'className': u'htCenter htMiddle ',
           u'data': u'id',
           u'editable': False,
           u'field_type': u'integer',
           u'knownBy': u'Batch ID',
           u'searchFormType': u'pick_from_list',
           u'sortOrder': u'none'},
          {u'className': u'htCenter htMiddle ',
           u'data': u'multiple_batch_id',
           u'editable': False,
           u'field_type': u'integer',
           u'knownBy': u'Upload ID',
           u'noSort': True,
           u'searchFormType': u'pick_from_list'},
          {u'className': u'htCenter htMiddle ',
           u'data': u'canonical_smiles',
           u'editable': False,
           u'field_type': u'string',
           u'knownBy': u'SMILES',
           u'noSort': True,
           u'searchFormType': u'pick_from_list'},
          {u'className': u'htCenter htMiddle ',
           u'data': u'standard_inchi',
           u'editable': False,
           u'field_type': u'string',
           u'knownBy': u'Standard InChI',
           u'noSort': True,
           u'searchFormType': u'pick_from_list'},
          {u'className': u'htCenter htMiddle ',
           u'data': u'standard_inchi_key',
           u'editable': False,
           u'field_type': u'string',
           u'knownBy': u'Standard InChI Key',
           u'noSort': True,
           u'searchFormType': u'pick_from_list'},
          {u'className': u'htCenter htMiddle ',
           u'data': u'related_molregno.compoundproperties.full_mwt',
           u'editable': False,
           u'field_type': u'string',
           u'knownBy': u'Molecular Weight',
           u'noSort': True,
           u'renderer_named': u'centeredNumericRenderer',
           u'searchFormType': u'pick_from_list'},
          {u'className': u'htCenter htMiddle ',
           u'data': u'related_molregno.compoundproperties.full_molformula',
           u'editable': False,
           u'field_type': u'string',
           u'knownBy': u'Molecular Formula',
           u'noSort': True,
           u'searchFormType': u'pick_from_list'},
          {u'className': u'htCenter htMiddle ',
           u'data': u'related_molregno.compoundproperties.alogp',
           u'editable': False,
           u'field_type': u'string',
           u'knownBy': u'ALogP (calculated)',
           u'noSort': True,
           u'renderer_named': u'centeredNumericRenderer',
           u'searchFormType': u'pick_from_list'}]]
        

        indices = ['dev__crv3__project__12']

        elasticsearch_client.index_dataset(batches, schemata, indices)
</code></pre>

        </div>

    </div>]