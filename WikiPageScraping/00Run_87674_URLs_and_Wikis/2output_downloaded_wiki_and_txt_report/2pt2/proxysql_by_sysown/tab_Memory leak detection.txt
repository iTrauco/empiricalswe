[<div class="wiki-body gollum-markdown-content instapaper_body" id="wiki-body">
        <div class="markdown-body">
          <p>Starting from version v1.3.0g , jemalloc embedded in ProxySQL is compiled with <code>--enable-prof</code>, allowing memory profiling.
Memory profiling is disabled by default.</p>
<p>To enable profiling, it is required to restart proxysql with an environment variable <code>MALLOC_CONF</code> to override the embedded/default jemalloc configuration.
The current jemalloc configuration is <code>xmalloc:true,lg_tcache_max:16,purge:decay</code>.
To enable memory profiling, <code>prof</code> and <code>prof_leak</code> need to be enabled, while <code>lg_prof_sample</code> and <code>lg_prof_interval</code> need to be tuned.
A suggested tuning for jemalloc memory profiler could be the follow:</p>
<pre><code>"xmalloc:true,lg_tcache_max:16,purge:decay,prof:true,prof_leak:true,lg_prof_sample:18,lg_prof_interval:30"
</code></pre>
<p>Therefore, the environment variable should be:</p>
<pre><code>MALLOC_CONF="xmalloc:true,lg_tcache_max:16,purge:decay,prof:true,prof_leak:true,lg_prof_sample:18,lg_prof_interval:30"
</code></pre>
<p>Details about jemalloc configuration can be found <a href="http://jemalloc.net/jemalloc.3.html" rel="nofollow">here</a>.</p>
<h2>
<a aria-hidden="true" class="anchor" href="#start-proxysql-with-memory-profiler" id="user-content-start-proxysql-with-memory-profiler"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Start ProxySQL with memory profiler</h2>
<h4>
<a aria-hidden="true" class="anchor" href="#using-init-script" id="user-content-using-init-script"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>using init script</h4>
<p>If you are running proxysql using init script <code>/etc/init.d/proxysql</code> , it is enough to add the follow line before the point when the process is started, for example at around line 19 in <code>/etc/init.d/proxysql</code>:</p>
<pre><code>export MALLOC_CONF="xmalloc:true,lg_tcache_max:16,purge:decay,prof:true,prof_leak:true,lg_prof_sample:18,lg_prof_interval:30"
</code></pre>
<h4>
<a aria-hidden="true" class="anchor" href="#without-init-script" id="user-content-without-init-script"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>without init script</h4>
<p>If you are running proxysql without init script <code>/etc/init.d/proxysql</code> , you need to ensure that the environment variable is set before starting <code>proxysql</code>. For example, if you run proxysql in foreground, you need to execute it similar to the following:</p>
<pre><code>MALLOC_CONF="xmalloc:true,lg_tcache_max:16,purge:decay,prof:true,prof_leak:true,lg_prof_sample:18,lg_prof_interval:30" proxysql -f -c /etc/proxysql.cnf
</code></pre>
<h2>
<a aria-hidden="true" class="anchor" href="#how-to-report-a-memory-leak" id="user-content-how-to-report-a-memory-leak"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>How to report a memory leak?</h2>
<p>jemalloc profiler will regularly write memory profile dumps in <code>/var/lib/proxysql</code> , with names <code>proxysql.&lt;pid&gt;.&lt;seq&gt;.i&lt;iseq&gt;.heap</code> .
To report a memory leak, please create a tarball with the dumps generated by jemalloc profiler and either create an issue or drop me an email.
Please also include which exact version of ProxySQL you are using, and on which OS:</p>
<ul>
<li>if you used an rpm or a deb package, specify which one exactly</li>
<li>if you compiled proxysql yourself, include <code>proxysql</code> binary in the report</li>
</ul>
<h2>
<a aria-hidden="true" class="anchor" href="#disable-profiling" id="user-content-disable-profiling"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Disable profiling</h2>
<p>To disable profiling, ProxySQL needs to be restarted without <code>MALLOC_CONF</code> set.</p>

        </div>

    </div>]