[<div class="wiki-body gollum-markdown-content instapaper_body" id="wiki-body">
        <div class="markdown-body">
          <h1>
<a aria-hidden="true" class="anchor" href="#mini-how-to-on-proxysql-configuration" id="user-content-mini-how-to-on-proxysql-configuration"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Mini HOW TO on ProxySQL Configuration</h1>
<p>This mini HOWTO described how to configure some of the component of ProxySQL step by step.
<em>This is not a complete guide</em>.</p>
<p>We assume you are already aware of ProxySQL architecture, and this HOWTO assumes that ProxySQL is being reconfigured using the standard SQL admin interface, available by default connecting to <a name="user-content-p6032"></a> port 6032 using trivial (changable) credentials:</p>
<pre><code>$ mysql -u admin -padmin -h 127.0.0.1 -P6032
</code></pre>
<p>First, let's verify that there is nothing configured. No entries in <code>mysql_servers</code>, nor in <code>mysql_replication_hostgroups</code> or <code>mysql_query_rules</code> tables.</p>
<div class="highlight highlight-source-sql"><pre>mysql<span class="pl-k">&gt;</span> \R Admin<span class="pl-k">&gt;</span>
PROMPT <span class="pl-k">set</span> to <span class="pl-s"><span class="pl-pds">'</span>Admin&gt; <span class="pl-pds">'</span></span>
Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> <span class="pl-k">*</span> <span class="pl-k">FROM</span> mysql_servers;
Empty <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)

Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> <span class="pl-k">*</span> <span class="pl-k">from</span> mysql_replication_hostgroups;
Empty <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)

Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> <span class="pl-k">*</span> <span class="pl-k">from</span> mysql_query_rules;
Empty <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<h3>
<a aria-hidden="true" class="anchor" href="#add-backends" id="user-content-add-backends"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Add backends</h3>
<p>For this demo, I started 3 mysql servers locally using MySQL Sandbox.
Let’s add them to ProxySQL.</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> <span class="pl-k">INSERT INTO</span> mysql_servers(hostgroup_id,hostname,port) <span class="pl-k">VALUES</span> (<span class="pl-c1">1</span>,<span class="pl-s"><span class="pl-pds">'</span>127.0.0.1<span class="pl-pds">'</span></span>,<span class="pl-c1">21891</span>);
Query OK, <span class="pl-c1">1</span> row affected (<span class="pl-c1">0</span>.<span class="pl-c1">01</span> sec)

Admin<span class="pl-k">&gt;</span> <span class="pl-k">INSERT INTO</span> mysql_servers(hostgroup_id,hostname,port) <span class="pl-k">VALUES</span> (<span class="pl-c1">1</span>,<span class="pl-s"><span class="pl-pds">'</span>127.0.0.1<span class="pl-pds">'</span></span>,<span class="pl-c1">21892</span>);
Query OK, <span class="pl-c1">1</span> row affected (<span class="pl-c1">0</span>.<span class="pl-c1">01</span> sec)

Admin<span class="pl-k">&gt;</span> <span class="pl-k">INSERT INTO</span> mysql_servers(hostgroup_id,hostname,port) <span class="pl-k">VALUES</span> (<span class="pl-c1">1</span>,<span class="pl-s"><span class="pl-pds">'</span>127.0.0.1<span class="pl-pds">'</span></span>,<span class="pl-c1">21893</span>);
Query OK, <span class="pl-c1">1</span> row affected (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)

Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> <span class="pl-k">*</span> <span class="pl-k">FROM</span> mysql_servers;
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>------------+-----------+-------+--------+--------+-------------+-----------------+---------------------+</span>
| hostgroup_id | hostname  | port  | status | weight | compression | max_connections | max_replication_lag |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>------------+-----------+-------+--------+--------+-------------+-----------------+---------------------+</span>
| <span class="pl-c1">1</span>            | <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21891</span> | ONLINE | <span class="pl-c1">1</span>      | <span class="pl-c1">0</span>           | <span class="pl-c1">1000</span>            | <span class="pl-c1">0</span>                   |
| <span class="pl-c1">1</span>            | <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21892</span> | ONLINE | <span class="pl-c1">1</span>      | <span class="pl-c1">0</span>           | <span class="pl-c1">1000</span>            | <span class="pl-c1">0</span>                   |
| <span class="pl-c1">1</span>            | <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21893</span> | ONLINE | <span class="pl-c1">1</span>      | <span class="pl-c1">0</span>           | <span class="pl-c1">1000</span>            | <span class="pl-c1">0</span>                   |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>------------+-----------+-------+--------+--------+-------------+-----------------+---------------------+</span>
<span class="pl-c1">3</span> rows <span class="pl-k">in</span> <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<p>All looks good so far.</p>
<blockquote>
<p>NOTE: By default, MySQL sandbox will set read_only = 0 on slaves. Set <code>set global read_only = 1</code> on the slaves.</p>
</blockquote>
<h3>
<a aria-hidden="true" class="anchor" href="#configure-monitoring" id="user-content-configure-monitoring"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Configure monitoring</h3>
<p>ProxySQL constantly monitors the servers it has configured. To do so, it is important to configure some variables.
Let’s configure them.</p>
<p>Add the credentials of the users required to monitor the backend (the user needs to be already created in mysql server):</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> <span class="pl-k">UPDATE</span> global_variables <span class="pl-k">SET</span> variable_value<span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>monitor<span class="pl-pds">'</span></span> <span class="pl-k">WHERE</span> variable_name<span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>mysql-monitor_username<span class="pl-pds">'</span></span>;
Query OK, <span class="pl-c1">1</span> row affected (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)

Admin<span class="pl-k">&gt;</span> <span class="pl-k">UPDATE</span> global_variables <span class="pl-k">SET</span> variable_value<span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>monitor<span class="pl-pds">'</span></span> <span class="pl-k">WHERE</span> variable_name<span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>mysql-monitor_password<span class="pl-pds">'</span></span>;
Query OK, <span class="pl-c1">1</span> row affected (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<p>Then we configure the various monitoring intervals:</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> <span class="pl-k">UPDATE</span> global_variables <span class="pl-k">SET</span> variable_value<span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>2000<span class="pl-pds">'</span></span> <span class="pl-k">WHERE</span> variable_name <span class="pl-k">IN</span> (<span class="pl-s"><span class="pl-pds">'</span>mysql-monitor_connect_interval<span class="pl-pds">'</span></span>,<span class="pl-s"><span class="pl-pds">'</span>mysql-monitor_ping_interval<span class="pl-pds">'</span></span>,<span class="pl-s"><span class="pl-pds">'</span>mysql-monitor_read_only_interval<span class="pl-pds">'</span></span>);
Query OK, <span class="pl-c1">3</span> rows affected (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)

Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> <span class="pl-k">*</span> <span class="pl-k">FROM</span> global_variables <span class="pl-k">WHERE</span> variable_name <span class="pl-k">LIKE</span> <span class="pl-s"><span class="pl-pds">'</span>mysql-monitor_%<span class="pl-pds">'</span></span>;
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>--------------------------------------+---------------------------------------------------+</span>
| variable_name                          | variable_value                                    |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>--------------------------------------+---------------------------------------------------+</span>
| mysql<span class="pl-k">-</span>monitor_history                  | <span class="pl-c1">600000</span>                                            |
| mysql<span class="pl-k">-</span>monitor_connect_interval         | <span class="pl-c1">2000</span>                                              |
| mysql<span class="pl-k">-</span>monitor_connect_timeout          | <span class="pl-c1">200</span>                                               |
| mysql<span class="pl-k">-</span>monitor_ping_interval            | <span class="pl-c1">2000</span>                                              |
| mysql<span class="pl-k">-</span>monitor_ping_timeout             | <span class="pl-c1">100</span>                                               |
| mysql<span class="pl-k">-</span>monitor_read_only_interval       | <span class="pl-c1">2000</span>                                              |
| mysql<span class="pl-k">-</span>monitor_read_only_timeout        | <span class="pl-c1">100</span>                                               |
| mysql<span class="pl-k">-</span>monitor_replication_lag_interval | <span class="pl-c1">10000</span>                                             |
| mysql<span class="pl-k">-</span>monitor_replication_lag_timeout  | <span class="pl-c1">1000</span>                                              |
| mysql<span class="pl-k">-</span>monitor_username                 | monitor                                           |
| mysql<span class="pl-k">-</span>monitor_password                 | monitor                                           |
| mysql<span class="pl-k">-</span>monitor_query_variables          | <span class="pl-k">SELECT</span> <span class="pl-k">*</span> <span class="pl-k">FROM</span> <span class="pl-c1">INFORMATION_SCHEMA</span>.<span class="pl-c1">GLOBAL_VARIABLES</span> |
| mysql<span class="pl-k">-</span>monitor_query_status             | <span class="pl-k">SELECT</span> <span class="pl-k">*</span> <span class="pl-k">FROM</span> <span class="pl-c1">INFORMATION_SCHEMA</span>.<span class="pl-c1">GLOBAL_STATUS</span>    |
| mysql<span class="pl-k">-</span>monitor_query_interval           | <span class="pl-c1">60000</span>                                             |
| mysql<span class="pl-k">-</span>monitor_query_timeout            | <span class="pl-c1">100</span>                                               |
| mysql<span class="pl-k">-</span>monitor_timer_cached             | true                                              |
| mysql<span class="pl-k">-</span>monitor_writer_is_also_reader    | true                                              |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>--------------------------------------+---------------------------------------------------+</span>
<span class="pl-c1">17</span> rows <span class="pl-k">in</span> <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<p>There are a lot of variables, and some are not used (yet) or not relevant for this howto. For now consider only the ones I listed before.
Changes related to MySQL Monitor in table <code>global_variables</code> take places only after running the command <code>LOAD MYSQL VARIABLES TO RUNTIME</code>, and they are permanently stored to disk after running <code>SAVE MYSQL VARIABLES TO DISK</code> .
Details <a href="https://github.com/sysown/proxysql/blob/v1.1.1/doc/configuration_system.md">here</a> .</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> LOAD MYSQL VARIABLES TO RUNTIME;
Query OK, <span class="pl-c1">0</span> rows affected (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)

Admin<span class="pl-k">&gt;</span> SAVE MYSQL VARIABLES TO DISK;
Query OK, <span class="pl-c1">54</span> rows affected (<span class="pl-c1">0</span>.<span class="pl-c1">02</span> sec)</pre></div>
<h3>
<a aria-hidden="true" class="anchor" href="#backends-health-check" id="user-content-backends-health-check"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Backend's health check</h3>
<p>Now, let’s see if ProxySQL is able to communicate with these hosts.
ProxySQL has several tables where stores monitoring information.</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> SHOW DATABASES;
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>---+---------+-------------------------------+</span>
| seq | name    | file                          |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>---+---------+-------------------------------+</span>
| <span class="pl-c1">0</span>   | main    |                               |
| <span class="pl-c1">2</span>   | disk    | <span class="pl-k">/</span>var<span class="pl-k">/</span>lib<span class="pl-k">/</span>proxysql<span class="pl-k">/</span><span class="pl-c1">proxysql</span>.<span class="pl-c1">db</span> |
| <span class="pl-c1">3</span>   | stats   |                               |
| <span class="pl-c1">4</span>   | monitor |                               |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>---+---------+-------------------------------+</span>
<span class="pl-c1">4</span> rows <span class="pl-k">in</span> <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)

Admin<span class="pl-k">&gt;</span> SHOW TABLES <span class="pl-k">FROM</span> monitor;
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>--------------------------------+</span>
| tables                           |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>--------------------------------+</span>
| mysql_server_connect             |
| mysql_server_connect_log         |
| mysql_server_ping                |
| mysql_server_ping_log            |
| mysql_server_read_only_log       |
| mysql_server_replication_lag_log |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>--------------------------------+</span>
<span class="pl-c1">6</span> rows <span class="pl-k">in</span> <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<p>Not all the tables in monitor are currently used.
For now we can check the relevant tables with the follow queries:</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> <span class="pl-k">*</span> <span class="pl-k">FROM</span> <span class="pl-c1">monitor</span>.<span class="pl-c1">mysql_server_connect_log</span> <span class="pl-k">ORDER BY</span> time_start_us <span class="pl-k">DESC</span> <span class="pl-k">LIMIT</span> <span class="pl-c1">10</span>;
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>---------+-------+------------------+----------------------+---------------+</span>
| hostname  | port  | time_start_us       | connect_success_time | connect_error |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>---------+-------+------------------+----------------------+---------------+</span>
| <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21891</span> | <span class="pl-c1">1456968814253432</span> | <span class="pl-c1">562</span>                  | <span class="pl-k">NULL</span>          |
| <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21892</span> | <span class="pl-c1">1456968814253432</span> | <span class="pl-c1">309</span>                  | <span class="pl-k">NULL</span>          |
| <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21893</span> | <span class="pl-c1">1456968814253432</span> | <span class="pl-c1">154</span>                  | <span class="pl-k">NULL</span>          |
| <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21891</span> | <span class="pl-c1">1456968812252146</span> | <span class="pl-c1">689</span>                  | <span class="pl-k">NULL</span>          |
| <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21892</span> | <span class="pl-c1">1456968812252146</span> | <span class="pl-c1">424</span>                  | <span class="pl-k">NULL</span>          |
| <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21893</span> | <span class="pl-c1">1456968812252146</span> | <span class="pl-c1">174</span>                  | <span class="pl-k">NULL</span>          |
| <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21891</span> | <span class="pl-c1">1456968810251585</span> | <span class="pl-c1">569</span>                  | <span class="pl-k">NULL</span>          |
| <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21892</span> | <span class="pl-c1">1456968810251585</span> | <span class="pl-c1">316</span>                  | <span class="pl-k">NULL</span>          |
| <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21893</span> | <span class="pl-c1">1456968810251585</span> | <span class="pl-c1">155</span>                  | <span class="pl-k">NULL</span>          |
| <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21891</span> | <span class="pl-c1">1456968808250762</span> | <span class="pl-c1">570</span>                  | <span class="pl-k">NULL</span>          |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>---------+-------+------------------+----------------------+---------------+</span>
<span class="pl-c1">10</span> rows <span class="pl-k">in</span> <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)

Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> <span class="pl-k">*</span> <span class="pl-k">FROM</span> <span class="pl-c1">monitor</span>.<span class="pl-c1">mysql_server_ping_log</span> <span class="pl-k">ORDER BY</span> time_start_us <span class="pl-k">DESC</span> <span class="pl-k">LIMIT</span> <span class="pl-c1">10</span>;
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>---------+-------+------------------+-------------------+------------+</span>
| hostname  | port  | time_start_us       | ping_success_time | ping_error |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>---------+-------+------------------+-------------------+------------+</span>
| <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21891</span> | <span class="pl-c1">1456968828686787</span> | <span class="pl-c1">124</span>               | <span class="pl-k">NULL</span>       |
| <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21892</span> | <span class="pl-c1">1456968828686787</span> | <span class="pl-c1">62</span>                | <span class="pl-k">NULL</span>       |
| <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21893</span> | <span class="pl-c1">1456968828686787</span> | <span class="pl-c1">57</span>                | <span class="pl-k">NULL</span>       |
| <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21891</span> | <span class="pl-c1">1456968826686385</span> | <span class="pl-c1">99</span>                | <span class="pl-k">NULL</span>       |
| <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21892</span> | <span class="pl-c1">1456968826686385</span> | <span class="pl-c1">46</span>                | <span class="pl-k">NULL</span>       |
| <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21893</span> | <span class="pl-c1">1456968826686385</span> | <span class="pl-c1">42</span>                | <span class="pl-k">NULL</span>       |
| <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21891</span> | <span class="pl-c1">1456968824685162</span> | <span class="pl-c1">135</span>               | <span class="pl-k">NULL</span>       |
| <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21892</span> | <span class="pl-c1">1456968824685162</span> | <span class="pl-c1">61</span>                | <span class="pl-k">NULL</span>       |
| <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21893</span> | <span class="pl-c1">1456968824685162</span> | <span class="pl-c1">57</span>                | <span class="pl-k">NULL</span>       |
| <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21891</span> | <span class="pl-c1">1456968822684689</span> | <span class="pl-c1">215</span>               | <span class="pl-k">NULL</span>       |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>---------+-------+------------------+-------------------+------------+</span>
<span class="pl-c1">10</span> rows <span class="pl-k">in</span> <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">01</span> sec)</pre></div>
<p>We can conclude that all of the configured servers are healthy.
One important thing to note here is that monitoring on connect and ping is performed based on the content of the table <code>mysql_servers</code>, even before this is loaded to RUNTIME. This approach is intentional: in this way it is possible to perform basic health checks before adding the nodes in production.</p>
<p>Now that we know that the servers are correctly monitored and alive, let’s enable them.</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> LOAD MYSQL SERVERS TO RUNTIME;
Query OK, <span class="pl-c1">0</span> rows affected (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)

Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> <span class="pl-k">*</span> <span class="pl-k">FROM</span> mysql_servers;
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>------------+-----------+-------+--------+--------+-------------+-----------------+---------------------+</span>
| hostgroup_id | hostname  | port  | status | weight | compression | max_connections | max_replication_lag |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>------------+-----------+-------+--------+--------+-------------+-----------------+---------------------+</span>
| <span class="pl-c1">1</span>            | <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21891</span> | ONLINE | <span class="pl-c1">1</span>      | <span class="pl-c1">0</span>           | <span class="pl-c1">1000</span>            | <span class="pl-c1">0</span>                   |
| <span class="pl-c1">1</span>            | <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21892</span> | ONLINE | <span class="pl-c1">1</span>      | <span class="pl-c1">0</span>           | <span class="pl-c1">1000</span>            | <span class="pl-c1">0</span>                   |
| <span class="pl-c1">1</span>            | <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21893</span> | ONLINE | <span class="pl-c1">1</span>      | <span class="pl-c1">0</span>           | <span class="pl-c1">1000</span>            | <span class="pl-c1">0</span>                   |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>------------+-----------+-------+--------+--------+-------------+-----------------+---------------------+</span>
<span class="pl-c1">3</span> rows <span class="pl-k">in</span> <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<h2>
<a aria-hidden="true" class="anchor" href="#mysql-replication-hostgroups" id="user-content-mysql-replication-hostgroups"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>MySQL replication hostgroups</h2>
<p>Let's check another table in the monitor schema , <code>monitor.mysql_server_read_only_log</code>:</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> <span class="pl-k">*</span> <span class="pl-k">FROM</span> <span class="pl-c1">monitor</span>.<span class="pl-c1">mysql_server_read_only_log</span> <span class="pl-k">ORDER BY</span> time_start_us <span class="pl-k">DESC</span> <span class="pl-k">LIMIT</span> <span class="pl-c1">10</span>;
Empty <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<p>This table is currently empty.
The reason is that ProxySQL checks the value of <code>read_only</code> only for servers configured in hostgroups that are configured in <code>mysql_replication_hostgroups</code>. This table is currently empty:</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> <span class="pl-k">*</span> <span class="pl-k">FROM</span> mysql_replication_hostgroups;
Empty <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<p>But what is the functionality of this table?
With this table, the listed hostgroups can be configured in pairs of writer and reader hostgroups.
ProxySQL will monitor the value of <code>read_only</code> for all the servers in specified hostgroups, and based on the value of <code>read_only</code> will assign the server to the writer or reader hostgroups.
To make an example:</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> SHOW CREATE TABLE mysql_replication_hostgroups\G
<span class="pl-k">***************************</span> <span class="pl-c1">1</span>. row <span class="pl-k">***************************</span>
       table: mysql_replication_hostgroups
Create Table: CREATE TABLE mysql_replication_hostgroups (
writer_hostgroup <span class="pl-k">INT</span> <span class="pl-k">CHECK</span> (writer_hostgroup<span class="pl-k">&gt;=</span><span class="pl-c1">0</span>) <span class="pl-k">NOT NULL</span> <span class="pl-k">PRIMARY KEY</span>,
reader_hostgroup <span class="pl-k">INT</span> <span class="pl-k">NOT NULL</span> <span class="pl-k">CHECK</span> (reader_hostgroup<span class="pl-k">&lt;&gt;</span>writer_hostgroup <span class="pl-k">AND</span> reader_hostgroup<span class="pl-k">&gt;</span><span class="pl-c1">0</span>),
comment <span class="pl-k">VARCHAR</span>,
UNIQUE (reader_hostgroup))
<span class="pl-c1">1</span> row <span class="pl-k">in</span> <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)

Admin<span class="pl-k">&gt;</span> <span class="pl-k">INSERT INTO</span> mysql_replication_hostgroups <span class="pl-k">VALUES</span> (<span class="pl-c1">1</span>,<span class="pl-c1">2</span>,<span class="pl-s"><span class="pl-pds">'</span>cluster1<span class="pl-pds">'</span></span>);
Query OK, <span class="pl-c1">1</span> row affected (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<p>Now, all the servers that are either configured in hostgroup 1 or 2 will be moved to the correct hostgroup:</p>
<ul>
<li>If they have <code>read_only=0</code> , they will be moved to hostgroup 1</li>
<li>If they have <code>read_only=1</code> , they will be moved to hostgroup 2</li>
</ul>
<p>But at this moment, the algorithm is still not running, because the new table isn't loaded at runtime. In fact:</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> <span class="pl-k">*</span> <span class="pl-k">FROM</span> mysql_servers;
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>------------+-----------+-------+--------+--------+-------------+-----------------+---------------------+</span>
| hostgroup_id | hostname  | port  | status | weight | compression | max_connections | max_replication_lag |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>------------+-----------+-------+--------+--------+-------------+-----------------+---------------------+</span>
| <span class="pl-c1">1</span>            | <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21891</span> | ONLINE | <span class="pl-c1">1</span>      | <span class="pl-c1">0</span>           | <span class="pl-c1">1000</span>            | <span class="pl-c1">0</span>                   |
| <span class="pl-c1">1</span>            | <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21892</span> | ONLINE | <span class="pl-c1">1</span>      | <span class="pl-c1">0</span>           | <span class="pl-c1">1000</span>            | <span class="pl-c1">0</span>                   |
| <span class="pl-c1">1</span>            | <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21893</span> | ONLINE | <span class="pl-c1">1</span>      | <span class="pl-c1">0</span>           | <span class="pl-c1">1000</span>            | <span class="pl-c1">0</span>                   |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>------------+-----------+-------+--------+--------+-------------+-----------------+---------------------+</span>
<span class="pl-c1">3</span> rows <span class="pl-k">in</span> <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<p>Let's load <code>mysql_replication_hostgroups</code> at runtime using the same <code>LOAD</code> command for MYSQL SERVERS : in fact <code>LOAD MYSQL SERVERS TO RUNTIME</code> processes both <code>mysql_servers</code> and <code>mysql_replication_hostgroups</code> tables.</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> LOAD MYSQL SERVERS TO RUNTIME;                                                                                                              Query OK, <span class="pl-c1">0</span> rows affected (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<p>Wait few seconds, and check again the status:</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> <span class="pl-k">*</span> <span class="pl-k">FROM</span> <span class="pl-c1">monitor</span>.<span class="pl-c1">mysql_server_read_only_log</span> <span class="pl-k">ORDER BY</span> time_start_us <span class="pl-k">DESC</span> <span class="pl-k">LIMIT</span> <span class="pl-c1">10</span>;                                                         <span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>---------+-------+------------------+--------------+-----------+-------+</span>
| hostname  | port  | time_start_us       | success_time | read_only | error |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>---------+-------+------------------+--------------+-----------+-------+</span>
| <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21891</span> | <span class="pl-c1">1456969634783579</span> | <span class="pl-c1">762</span>          | <span class="pl-c1">0</span>         | <span class="pl-k">NULL</span>  |
| <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21892</span> | <span class="pl-c1">1456969634783579</span> | <span class="pl-c1">378</span>          | <span class="pl-c1">1</span>         | <span class="pl-k">NULL</span>  |
| <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21893</span> | <span class="pl-c1">1456969634783579</span> | <span class="pl-c1">317</span>          | <span class="pl-c1">1</span>         | <span class="pl-k">NULL</span>  |
| <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21891</span> | <span class="pl-c1">1456969632783364</span> | <span class="pl-c1">675</span>          | <span class="pl-c1">0</span>         | <span class="pl-k">NULL</span>  |
| <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21892</span> | <span class="pl-c1">1456969632783364</span> | <span class="pl-c1">539</span>          | <span class="pl-c1">1</span>         | <span class="pl-k">NULL</span>  |
| <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21893</span> | <span class="pl-c1">1456969632783364</span> | <span class="pl-c1">550</span>          | <span class="pl-c1">1</span>         | <span class="pl-k">NULL</span>  |
| <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21891</span> | <span class="pl-c1">1456969630783159</span> | <span class="pl-c1">493</span>          | <span class="pl-c1">0</span>         | <span class="pl-k">NULL</span>  |
| <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21892</span> | <span class="pl-c1">1456969630783159</span> | <span class="pl-c1">626</span>          | <span class="pl-c1">1</span>         | <span class="pl-k">NULL</span>  |
| <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21893</span> | <span class="pl-c1">1456969630783159</span> | <span class="pl-c1">572</span>          | <span class="pl-c1">1</span>         | <span class="pl-k">NULL</span>  |
| <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21891</span> | <span class="pl-c1">1456969628782328</span> | <span class="pl-c1">433</span>          | <span class="pl-c1">0</span>         | <span class="pl-k">NULL</span>  |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>---------+-------+------------------+--------------+-----------+-------+</span>
<span class="pl-c1">10</span> rows <span class="pl-k">in</span> <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">01</span> sec)</pre></div>
<p>Allright, ProxySQL is monitoring the <code>read_only</code> value for the servers.
And also created hostgroup2 where it moved servers with <code>read_only=1</code> (readers) from hostgroup1 .</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> <span class="pl-k">*</span> <span class="pl-k">FROM</span> mysql_servers;
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>------------+-----------+-------+--------+--------+-------------+-----------------+---------------------+</span>
| hostgroup_id | hostname  | port  | status | weight | compression | max_connections | max_replication_lag |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>------------+-----------+-------+--------+--------+-------------+-----------------+---------------------+</span>
| <span class="pl-c1">1</span>            | <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21891</span> | ONLINE | <span class="pl-c1">1</span>      | <span class="pl-c1">0</span>           | <span class="pl-c1">1000</span>            | <span class="pl-c1">0</span>                   |
| <span class="pl-c1">2</span>            | <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21892</span> | ONLINE | <span class="pl-c1">1</span>      | <span class="pl-c1">0</span>           | <span class="pl-c1">1000</span>            | <span class="pl-c1">0</span>                   |
| <span class="pl-c1">2</span>            | <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21893</span> | ONLINE | <span class="pl-c1">1</span>      | <span class="pl-c1">0</span>           | <span class="pl-c1">1000</span>            | <span class="pl-c1">0</span>                   |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>------------+-----------+-------+--------+--------+-------------+-----------------+---------------------+</span>
<span class="pl-c1">3</span> rows <span class="pl-k">in</span> <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<p>All looks good. It is time to save the configuration to disk:</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> SAVE MYSQL SERVERS TO DISK;
Query OK, <span class="pl-c1">0</span> rows affected (<span class="pl-c1">0</span>.<span class="pl-c1">01</span> sec)

Admin<span class="pl-k">&gt;</span> SAVE MYSQL VARIABLES TO DISK;
Query OK, <span class="pl-c1">54</span> rows affected (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<h2>
<a aria-hidden="true" class="anchor" href="#mysql-users" id="user-content-mysql-users"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>MySQL Users</h2>
<p>After we configure the servers in <code>mysql_servers</code>, we also need to configure mysql users.
This is performed using table <code>mysql_users</code>:</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> <span class="pl-k">*</span> <span class="pl-k">FROM</span> mysql_users;
Empty <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)

Admin<span class="pl-k">&gt;</span> SHOW CREATE TABLE mysql_users\G
<span class="pl-k">***************************</span> <span class="pl-c1">1</span>. row <span class="pl-k">***************************</span>
       table: mysql_users
Create Table: CREATE TABLE mysql_users (
username <span class="pl-k">VARCHAR</span> <span class="pl-k">NOT NULL</span>,
password <span class="pl-k">VARCHAR</span>,
active <span class="pl-k">INT</span> <span class="pl-k">CHECK</span> (active <span class="pl-k">IN</span> (<span class="pl-c1">0</span>,<span class="pl-c1">1</span>)) <span class="pl-k">NOT NULL</span> DEFAULT <span class="pl-c1">1</span>,
use_ssl <span class="pl-k">INT</span> <span class="pl-k">CHECK</span> (use_ssl <span class="pl-k">IN</span> (<span class="pl-c1">0</span>,<span class="pl-c1">1</span>)) <span class="pl-k">NOT NULL</span> DEFAULT <span class="pl-c1">0</span>,
default_hostgroup <span class="pl-k">INT</span> <span class="pl-k">NOT NULL</span> DEFAULT <span class="pl-c1">0</span>,
default_schema <span class="pl-k">VARCHAR</span>,
schema_locked <span class="pl-k">INT</span> <span class="pl-k">CHECK</span> (schema_locked <span class="pl-k">IN</span> (<span class="pl-c1">0</span>,<span class="pl-c1">1</span>)) <span class="pl-k">NOT NULL</span> DEFAULT <span class="pl-c1">0</span>,
transaction_persistent <span class="pl-k">INT</span> <span class="pl-k">CHECK</span> (transaction_persistent <span class="pl-k">IN</span> (<span class="pl-c1">0</span>,<span class="pl-c1">1</span>)) <span class="pl-k">NOT NULL</span> DEFAULT <span class="pl-c1">0</span>,
fast_forward <span class="pl-k">INT</span> <span class="pl-k">CHECK</span> (fast_forward <span class="pl-k">IN</span> (<span class="pl-c1">0</span>,<span class="pl-c1">1</span>)) <span class="pl-k">NOT NULL</span> DEFAULT <span class="pl-c1">0</span>,
backend <span class="pl-k">INT</span> <span class="pl-k">CHECK</span> (backend <span class="pl-k">IN</span> (<span class="pl-c1">0</span>,<span class="pl-c1">1</span>)) <span class="pl-k">NOT NULL</span> DEFAULT <span class="pl-c1">1</span>,
frontend <span class="pl-k">INT</span> <span class="pl-k">CHECK</span> (frontend <span class="pl-k">IN</span> (<span class="pl-c1">0</span>,<span class="pl-c1">1</span>)) <span class="pl-k">NOT NULL</span> DEFAULT <span class="pl-c1">1</span>,
max_connections <span class="pl-k">INT</span> <span class="pl-k">CHECK</span> (max_connections <span class="pl-k">&gt;=</span><span class="pl-c1">0</span>) <span class="pl-k">NOT NULL</span> DEFAULT <span class="pl-c1">10000</span>,
<span class="pl-k">PRIMARY KEY</span> (username, backend),
UNIQUE (username, frontend))
<span class="pl-c1">1</span> row <span class="pl-k">in</span> <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<p>Table is initially empty.
Let's start configuring users.</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> <span class="pl-k">INSERT INTO</span> mysql_users(username,password,default_hostgroup) <span class="pl-k">VALUES</span> (<span class="pl-s"><span class="pl-pds">'</span>root<span class="pl-pds">'</span></span>,<span class="pl-s"><span class="pl-pds">'</span><span class="pl-pds">'</span></span>,<span class="pl-c1">1</span>);
Query OK, <span class="pl-c1">1</span> row affected (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)

Admin<span class="pl-k">&gt;</span> <span class="pl-k">INSERT INTO</span> mysql_users(username,password,default_hostgroup) <span class="pl-k">VALUES</span> (<span class="pl-s"><span class="pl-pds">'</span>msandbox<span class="pl-pds">'</span></span>,<span class="pl-s"><span class="pl-pds">'</span>msandbox<span class="pl-pds">'</span></span>,<span class="pl-c1">1</span>);
Query OK, <span class="pl-c1">1</span> row affected (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)

Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> <span class="pl-k">*</span> <span class="pl-k">FROM</span> mysql_users;                                                                                                                      <span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>--------+----------+--------+---------+-------------------+----------------+---------------+------------------------+--------------+---------+----------+-----------------+</span>
| username | password | active | use_ssl | default_hostgroup | default_schema | schema_locked | transaction_persistent | fast_forward | backend | frontend | max_connections |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>--------+----------+--------+---------+-------------------+----------------+---------------+------------------------+--------------+---------+----------+-----------------+</span>
| root     |          | <span class="pl-c1">1</span>      | <span class="pl-c1">0</span>       | <span class="pl-c1">1</span>                 | <span class="pl-k">NULL</span>           | <span class="pl-c1">0</span>             | <span class="pl-c1">0</span>                      | <span class="pl-c1">0</span>            | <span class="pl-c1">1</span>       | <span class="pl-c1">1</span>        | <span class="pl-c1">10000</span>           |
| msandbox | msandbox | <span class="pl-c1">1</span>      | <span class="pl-c1">0</span>       | <span class="pl-c1">1</span>                 | <span class="pl-k">NULL</span>           | <span class="pl-c1">0</span>             | <span class="pl-c1">0</span>                      | <span class="pl-c1">0</span>            | <span class="pl-c1">1</span>       | <span class="pl-c1">1</span>        | <span class="pl-c1">10000</span>           |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>--------+----------+--------+---------+-------------------+----------------+---------------+------------------------+--------------+---------+----------+-----------------+</span>
<span class="pl-c1">2</span> rows <span class="pl-k">in</span> <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<p>We left most fields with the default value. The most important fields we configured are :</p>
<ul>
<li><code>username</code></li>
<li><code>password</code></li>
<li><code>default_hostgroup</code></li>
</ul>
<p>The meaning of <code>username</code> and <code>password</code> should be very clear.
<code>default_hostgroup</code> is the hostgroup that will be used to send traffic generated by that specific user if there is no matching query rules for a specific query (more details later on).</p>
<p>Again, load configuration to runtime to make it live, and save it to disk to make it persistent across restart.</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> LOAD MYSQL USERS TO RUNTIME;
Query OK, <span class="pl-c1">0</span> rows affected (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)

Admin<span class="pl-k">&gt;</span> SAVE MYSQL USERS TO DISK;
Query OK, <span class="pl-c1">0</span> rows affected (<span class="pl-c1">0</span>.<span class="pl-c1">01</span> sec)</pre></div>
<p><a name="user-content-p6033"></a>
We can now try to connect from a different terminal:</p>
<pre><code>vagrant@ubuntu-14:~$ mysql -u msandbox -pmsandbox -h 127.0.0.1 -P6033 -e "SELECT 1"
Warning: Using a password on the command line interface can be insecure.
+---+
| 1 |
+---+
| 1 |
+---+
vagrant@ubuntu-14:~$ mysql -u msandbox -pmsandbox -h 127.0.0.1 -P6033 -e "SELECT @@port"
Warning: Using a password on the command line interface can be insecure.
+--------+
| @@port |
+--------+
|  21891 |
+--------+
</code></pre>
<p>It seems it worked, and not surprisingly the query was sent to the server listening on port 21891, the master, because it is configured on hostgroup1 and is the default for user msandbox.</p>
<h2>
<a aria-hidden="true" class="anchor" href="#functional-tests" id="user-content-functional-tests"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Functional tests</h2>
<p>Now we can try some "benchmark" to verify that ProxySQL is functional.</p>
<p>Assuming you already created sysbench table, you can run a load test using:</p>
<pre><code>vagrant@ubuntu-14:~/sysbench/sysbench-0.5/sysbench$ ./sysbench --report-interval=5 --num-threads=4 --num-requests=0 --max-time=20 --test=tests/db/oltp.lua --mysql-user='msandbox' --mysql-password='msandbox' --oltp-table-size=10000 --mysql-host=127.0.0.1 --mysql-port=6033 run

[ output omitted ]
</code></pre>
<p>All run correctly through ProxySQL . Does ProxySQL exports metrics about what was running? Yes...</p>
<blockquote>
<p>For older versions of sysbench, <code>report-interval</code> should be removed and <code>--db-ps-mode=disable</code> added.</p>
</blockquote>
<pre><code>sysbench --num-threads=4 --max-requests=0 --max-time=20 --test=tests/db/oltp.lua --mysql-user='msandbox' --mysql-password='msandbox' --oltp-table-size=10000 --mysql-host=127.0.0.1 --mysql-port=6033 --db-ps-mode=disable run

[ output omitted ]
</code></pre>
<h2>
<a aria-hidden="true" class="anchor" href="#proxysql-statistics" id="user-content-proxysql-statistics"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>ProxySQL Statistics</h2>
<p>ProxySQL collects a lot of real time statistics in the <code>stats</code> schema:</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> SHOW SCHEMAS;
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>---+---------+-------------------------------+</span>
| seq | name    | file                          |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>---+---------+-------------------------------+</span>
| <span class="pl-c1">0</span>   | main    |                               |
| <span class="pl-c1">2</span>   | disk    | <span class="pl-k">/</span>var<span class="pl-k">/</span>lib<span class="pl-k">/</span>proxysql<span class="pl-k">/</span><span class="pl-c1">proxysql</span>.<span class="pl-c1">db</span> |
| <span class="pl-c1">3</span>   | stats   |                               |
| <span class="pl-c1">4</span>   | monitor |                               |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>---+---------+-------------------------------+</span>
<span class="pl-c1">4</span> rows <span class="pl-k">in</span> <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)

Admin<span class="pl-k">&gt;</span> SHOW TABLES <span class="pl-k">FROM</span> stats;
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>------------------------------+</span>
| tables                         |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>------------------------------+</span>
| stats_mysql_query_rules        |
| stats_mysql_commands_counters  |
| stats_mysql_processlist        |
| stats_mysql_connection_pool    |
| stats_mysql_query_digest       |
| stats_mysql_query_digest_reset |
| stats_mysql_global             |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>------------------------------+</span>
<span class="pl-c1">7</span> rows <span class="pl-k">in</span> <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<p>A lot of tables are present the stats schema. We will analyze the all.</p>
<h4>
<a aria-hidden="true" class="anchor" href="#statsstats_mysql_connection_pool" id="user-content-statsstats_mysql_connection_pool"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>stats.stats_mysql_connection_pool</h4>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> <span class="pl-k">*</span> <span class="pl-k">FROM</span> <span class="pl-c1">stats</span>.<span class="pl-c1">stats_mysql_connection_pool</span>;
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>---------+-----------+----------+--------------+----------+----------+--------+---------+---------+-----------------+-----------------+</span>
| hostgroup | srv_host  | srv_port | status       | ConnUsed | ConnFree | ConnOK | ConnERR | Queries | Bytes_data_sent | Bytes_data_recv |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>---------+-----------+----------+--------------+----------+----------+--------+---------+---------+-----------------+-----------------+</span>
| <span class="pl-c1">1</span>         | <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21891</span>    | ONLINE       | <span class="pl-c1">0</span>        | <span class="pl-c1">4</span>        | <span class="pl-c1">5</span>      | <span class="pl-c1">0</span>       | <span class="pl-c1">144982</span>  | <span class="pl-c1">7865186</span>         | <span class="pl-c1">278734683</span>       |
| <span class="pl-c1">1</span>         | <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21892</span>    | OFFLINE_HARD | <span class="pl-c1">0</span>        | <span class="pl-c1">0</span>        | <span class="pl-c1">0</span>      | <span class="pl-c1">0</span>       | <span class="pl-c1">0</span>       | <span class="pl-c1">0</span>               | <span class="pl-c1">0</span>               |
| <span class="pl-c1">2</span>         | <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21893</span>    | ONLINE       | <span class="pl-c1">0</span>        | <span class="pl-c1">0</span>        | <span class="pl-c1">0</span>      | <span class="pl-c1">0</span>       | <span class="pl-c1">0</span>       | <span class="pl-c1">0</span>               | <span class="pl-c1">0</span>               |
| <span class="pl-c1">2</span>         | <span class="pl-c1">127</span>.<span class="pl-c1">0</span>.<span class="pl-c1">0</span>.<span class="pl-c1">1</span> | <span class="pl-c1">21892</span>    | ONLINE       | <span class="pl-c1">0</span>        | <span class="pl-c1">0</span>        | <span class="pl-c1">0</span>      | <span class="pl-c1">0</span>       | <span class="pl-c1">0</span>       | <span class="pl-c1">0</span>               | <span class="pl-c1">0</span>               |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>---------+-----------+----------+--------------+----------+----------+--------+---------+---------+-----------------+-----------------+</span>
<span class="pl-c1">4</span> rows <span class="pl-k">in</span> <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<p>A small parenthesis: currently, when a server is removed (completely removed, or moved away from a hostgroup) , it is internally marked as <code>OFFLINE_HARD</code> and not really removed.
This is why it shows server on port 21892 as <code>OFFLINE_HARD</code> for hostgroup1 .</p>
<p>This table returns a lot of information about the traffic sent to each server.
As expected, all traffic was sent to server on port 21891 , the master.</p>
<h4>
<a aria-hidden="true" class="anchor" href="#stats_mysql_commands_counters" id="user-content-stats_mysql_commands_counters"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>stats_mysql_commands_counters</h4>
<p>What type of queries were exactly? Table <code>stats_mysql_commands_counters</code> anwswers this question:</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> <span class="pl-k">*</span> <span class="pl-k">FROM</span> stats_mysql_commands_counters <span class="pl-k">WHERE</span> Total_cnt;
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>-------+---------------+-----------+-----------+-----------+---------+---------+----------+----------+-----------+-----------+--------+--------+---------+----------+</span>
| Command | Total_Time_us | Total_cnt | cnt_100us | cnt_500us | cnt_1ms | cnt_5ms | cnt_10ms | cnt_50ms | cnt_100ms | cnt_500ms | cnt_1s | cnt_5s | cnt_10s | cnt_INFs |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>-------+---------------+-----------+-----------+-----------+---------+---------+----------+----------+-----------+-----------+--------+--------+---------+----------+</span>
| <span class="pl-k">BEGIN</span>   | <span class="pl-c1">1921940</span>       | <span class="pl-c1">7249</span>      | <span class="pl-c1">4214</span>      | <span class="pl-c1">2106</span>      | <span class="pl-c1">570</span>     | <span class="pl-c1">340</span>     | <span class="pl-c1">14</span>       | <span class="pl-c1">5</span>        | <span class="pl-c1">0</span>         | <span class="pl-c1">0</span>         | <span class="pl-c1">0</span>      | <span class="pl-c1">0</span>      | <span class="pl-c1">0</span>       | <span class="pl-c1">0</span>        |
| <span class="pl-k">COMMIT</span>  | <span class="pl-c1">5986400</span>       | <span class="pl-c1">7249</span>      | <span class="pl-c1">119</span>       | <span class="pl-c1">3301</span>      | <span class="pl-c1">1912</span>    | <span class="pl-c1">1864</span>    | <span class="pl-c1">44</span>       | <span class="pl-c1">8</span>        | <span class="pl-c1">1</span>         | <span class="pl-c1">0</span>         | <span class="pl-c1">0</span>      | <span class="pl-c1">0</span>      | <span class="pl-c1">0</span>       | <span class="pl-c1">0</span>        |
| <span class="pl-k">DELETE</span>  | <span class="pl-c1">2428829</span>       | <span class="pl-c1">7249</span>      | <span class="pl-c1">325</span>       | <span class="pl-c1">5856</span>      | <span class="pl-c1">585</span>     | <span class="pl-c1">475</span>     | <span class="pl-c1">5</span>        | <span class="pl-c1">3</span>        | <span class="pl-c1">0</span>         | <span class="pl-c1">0</span>         | <span class="pl-c1">0</span>      | <span class="pl-c1">0</span>      | <span class="pl-c1">0</span>       | <span class="pl-c1">0</span>        |
| INSERT  | <span class="pl-c1">2260129</span>       | <span class="pl-c1">7249</span>      | <span class="pl-c1">356</span>       | <span class="pl-c1">5948</span>      | <span class="pl-c1">529</span>     | <span class="pl-c1">408</span>     | <span class="pl-c1">6</span>        | <span class="pl-c1">2</span>        | <span class="pl-c1">0</span>         | <span class="pl-c1">0</span>         | <span class="pl-c1">0</span>      | <span class="pl-c1">0</span>      | <span class="pl-c1">0</span>       | <span class="pl-c1">0</span>        |
| <span class="pl-k">SELECT</span>  | <span class="pl-c1">40461204</span>      | <span class="pl-c1">101490</span>    | <span class="pl-c1">12667</span>     | <span class="pl-c1">69530</span>     | <span class="pl-c1">11919</span>   | <span class="pl-c1">6943</span>    | <span class="pl-c1">268</span>      | <span class="pl-c1">149</span>      | <span class="pl-c1">13</span>        | <span class="pl-c1">1</span>         | <span class="pl-c1">0</span>      | <span class="pl-c1">0</span>      | <span class="pl-c1">0</span>       | <span class="pl-c1">0</span>        |
| <span class="pl-k">UPDATE</span>  | <span class="pl-c1">6635032</span>       | <span class="pl-c1">14498</span>     | <span class="pl-c1">333</span>       | <span class="pl-c1">11149</span>     | <span class="pl-c1">1597</span>    | <span class="pl-c1">1361</span>    | <span class="pl-c1">42</span>       | <span class="pl-c1">16</span>       | <span class="pl-c1">0</span>         | <span class="pl-c1">0</span>         | <span class="pl-c1">0</span>      | <span class="pl-c1">0</span>      | <span class="pl-c1">0</span>       | <span class="pl-c1">0</span>        |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>-------+---------------+-----------+-----------+-----------+---------+---------+----------+----------+-----------+-----------+--------+--------+---------+----------+</span>
<span class="pl-c1">6</span> rows <span class="pl-k">in</span> <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<p>Table <code>stats_mysql_commands_counters</code> returns detailed information about the type of statements executed, and the distribution of execution time!</p>
<h3>
<a aria-hidden="true" class="anchor" href="#stats_mysql_query_digest" id="user-content-stats_mysql_query_digest"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>stats_mysql_query_digest</h3>
<p>Table <code>stats_mysql_commands_counters</code> provides very useful information.
Can we get more details about the query that were executed? Table <code>stats_mysql_query_digest</code> helps in this:</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> <span class="pl-k">*</span> <span class="pl-k">FROM</span> stats_mysql_query_digest <span class="pl-k">ORDER BY</span> sum_time <span class="pl-k">DESC</span>;
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>---------+--------------------+----------+--------------------+----------------------------------------------------------------------+------------+------------+------------+----------+----------+----------+</span>
| hostgroup | schemaname         | username | digest             | digest_text                                                          | count_star | first_seen | last_seen  | sum_time | min_time | max_time |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>---------+--------------------+----------+--------------------+----------------------------------------------------------------------+------------+------------+------------+----------+----------+----------+</span>
| <span class="pl-c1">1</span>         | sbtest             | msandbox | 0x13781C1DBF001A0C | <span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>?                                     | <span class="pl-c1">72490</span>      | <span class="pl-c1">1456971810</span> | <span class="pl-c1">1456971830</span> | <span class="pl-c1">17732590</span> | <span class="pl-c1">23</span>       | <span class="pl-c1">58935</span>    |
| <span class="pl-c1">1</span>         | sbtest             | msandbox | 0x704822A0F7D3CD60 | <span class="pl-k">SELECT DISTINCT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id BETWEEN ? <span class="pl-k">AND</span> ?<span class="pl-k">+</span>? <span class="pl-k">ORDER BY</span> c | <span class="pl-c1">7249</span>       | <span class="pl-c1">1456971810</span> | <span class="pl-c1">1456971830</span> | <span class="pl-c1">9629225</span>  | <span class="pl-c1">20</span>       | <span class="pl-c1">121604</span>   |
| <span class="pl-c1">1</span>         | sbtest             | msandbox | 0xADF3DDF2877EEAAF | <span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id BETWEEN ? <span class="pl-k">AND</span> ?<span class="pl-k">+</span>? <span class="pl-k">ORDER BY</span> c          | <span class="pl-c1">7249</span>       | <span class="pl-c1">1456971810</span> | <span class="pl-c1">1456971830</span> | <span class="pl-c1">6650716</span>  | <span class="pl-c1">26</span>       | <span class="pl-c1">76159</span>    |
| <span class="pl-c1">1</span>         | sbtest             | msandbox | 0x5DBEB0DD695FBF25 | <span class="pl-k">COMMIT</span>                                                               | <span class="pl-c1">7249</span>       | <span class="pl-c1">1456971810</span> | <span class="pl-c1">1456971830</span> | <span class="pl-c1">5986400</span>  | <span class="pl-c1">64</span>       | <span class="pl-c1">59229</span>    |
| <span class="pl-c1">1</span>         | sbtest             | msandbox | 0xCCB481C7C198E52B | <span class="pl-k">UPDATE</span> sbtest1 <span class="pl-k">SET</span> k<span class="pl-k">=</span>k<span class="pl-k">+</span>? <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>?                                  | <span class="pl-c1">7249</span>       | <span class="pl-c1">1456971810</span> | <span class="pl-c1">1456971830</span> | <span class="pl-c1">3948930</span>  | <span class="pl-c1">44</span>       | <span class="pl-c1">47860</span>    |
| <span class="pl-c1">1</span>         | sbtest             | msandbox | 0x7DD56217AF7A5197 | <span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id BETWEEN ? <span class="pl-k">AND</span> ?<span class="pl-k">+</span>?                     | <span class="pl-c1">7249</span>       | <span class="pl-c1">1456971810</span> | <span class="pl-c1">1456971830</span> | <span class="pl-c1">3235986</span>  | <span class="pl-c1">22</span>       | <span class="pl-c1">24624</span>    |
| <span class="pl-c1">1</span>         | sbtest             | msandbox | 0xE75DB8313E268CF3 | <span class="pl-k">SELECT</span> <span class="pl-c1">SUM</span>(K) <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id BETWEEN ? <span class="pl-k">AND</span> ?<span class="pl-k">+</span>?                | <span class="pl-c1">7249</span>       | <span class="pl-c1">1456971810</span> | <span class="pl-c1">1456971830</span> | <span class="pl-c1">3211197</span>  | <span class="pl-c1">51</span>       | <span class="pl-c1">29569</span>    |
| <span class="pl-c1">1</span>         | sbtest             | msandbox | 0x5A23CA36FB239BC9 | <span class="pl-k">UPDATE</span> sbtest1 <span class="pl-k">SET</span> c<span class="pl-k">=</span>? <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>?                                    | <span class="pl-c1">7249</span>       | <span class="pl-c1">1456971810</span> | <span class="pl-c1">1456971830</span> | <span class="pl-c1">2686102</span>  | <span class="pl-c1">23</span>       | <span class="pl-c1">27779</span>    |
| <span class="pl-c1">1</span>         | sbtest             | msandbox | 0x55319B9EE365BEB5 | <span class="pl-k">DELETE</span> <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>?                                       | <span class="pl-c1">7249</span>       | <span class="pl-c1">1456971810</span> | <span class="pl-c1">1456971830</span> | <span class="pl-c1">2428829</span>  | <span class="pl-c1">29</span>       | <span class="pl-c1">11676</span>    |
| <span class="pl-c1">1</span>         | sbtest             | msandbox | 0x10634DACE52A0A02 | <span class="pl-k">INSERT INTO</span> sbtest1 (id, k, c, pad) <span class="pl-k">VALUES</span> (?, ?, ?, ?)              | <span class="pl-c1">7249</span>       | <span class="pl-c1">1456971810</span> | <span class="pl-c1">1456971830</span> | <span class="pl-c1">2260129</span>  | <span class="pl-c1">61</span>       | <span class="pl-c1">13711</span>    |
| <span class="pl-c1">1</span>         | sbtest             | msandbox | 0x4760CBDEFAD1519E | <span class="pl-k">BEGIN</span>                                                                | <span class="pl-c1">7249</span>       | <span class="pl-c1">1456971810</span> | <span class="pl-c1">1456971830</span> | <span class="pl-c1">1921940</span>  | <span class="pl-c1">30</span>       | <span class="pl-c1">39871</span>    |
| <span class="pl-c1">1</span>         | information_schema | msandbox | 0x9DD5A40E1C46AE52 | <span class="pl-k">SELECT</span> ?                                                             | <span class="pl-c1">1</span>          | <span class="pl-c1">1456970758</span> | <span class="pl-c1">1456970758</span> | <span class="pl-c1">1217</span>     | <span class="pl-c1">1217</span>     | <span class="pl-c1">1217</span>     |
| <span class="pl-c1">1</span>         | information_schema | msandbox | 0xA90D80E5831B091B | <span class="pl-k">SELECT</span> @@port                                                        | <span class="pl-c1">1</span>          | <span class="pl-c1">1456970769</span> | <span class="pl-c1">1456970769</span> | <span class="pl-c1">273</span>      | <span class="pl-c1">273</span>      | <span class="pl-c1">273</span>      |
| <span class="pl-c1">1</span>         | information_schema | msandbox | 0x52A2BA0B226CD90D | <span class="pl-k">select</span> @@version_comment <span class="pl-k">limit</span> ?                                     | <span class="pl-c1">2</span>          | <span class="pl-c1">1456970758</span> | <span class="pl-c1">1456970769</span> | <span class="pl-c1">0</span>        | <span class="pl-c1">0</span>        | <span class="pl-c1">0</span>        |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>---------+--------------------+----------+--------------------+----------------------------------------------------------------------+------------+------------+------------+----------+----------+----------+</span>
<span class="pl-c1">14</span> rows <span class="pl-k">in</span> <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<p>Too much information makes it hard to format it here.
Let get only important metrics:</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> hostgroup hg, sum_time, count_star, digest_text <span class="pl-k">FROM</span> stats_mysql_query_digest <span class="pl-k">ORDER BY</span> sum_time <span class="pl-k">DESC</span>;
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>--+----------+------------+----------------------------------------------------------------------+</span>
| hg | sum_time | count_star | digest_text                                                          |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>--+----------+------------+----------------------------------------------------------------------+</span>
| <span class="pl-c1">1</span>  | <span class="pl-c1">17732590</span> | <span class="pl-c1">72490</span>      | <span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>?                                     |
| <span class="pl-c1">1</span>  | <span class="pl-c1">9629225</span>  | <span class="pl-c1">7249</span>       | <span class="pl-k">SELECT DISTINCT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id BETWEEN ? <span class="pl-k">AND</span> ?<span class="pl-k">+</span>? <span class="pl-k">ORDER BY</span> c |
| <span class="pl-c1">1</span>  | <span class="pl-c1">6650716</span>  | <span class="pl-c1">7249</span>       | <span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id BETWEEN ? <span class="pl-k">AND</span> ?<span class="pl-k">+</span>? <span class="pl-k">ORDER BY</span> c          |
| <span class="pl-c1">1</span>  | <span class="pl-c1">5986400</span>  | <span class="pl-c1">7249</span>       | <span class="pl-k">COMMIT</span>                                                               |
| <span class="pl-c1">1</span>  | <span class="pl-c1">3948930</span>  | <span class="pl-c1">7249</span>       | <span class="pl-k">UPDATE</span> sbtest1 <span class="pl-k">SET</span> k<span class="pl-k">=</span>k<span class="pl-k">+</span>? <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>?                                  |
| <span class="pl-c1">1</span>  | <span class="pl-c1">3235986</span>  | <span class="pl-c1">7249</span>       | <span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id BETWEEN ? <span class="pl-k">AND</span> ?<span class="pl-k">+</span>?                     |
| <span class="pl-c1">1</span>  | <span class="pl-c1">3211197</span>  | <span class="pl-c1">7249</span>       | <span class="pl-k">SELECT</span> <span class="pl-c1">SUM</span>(K) <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id BETWEEN ? <span class="pl-k">AND</span> ?<span class="pl-k">+</span>?                |
| <span class="pl-c1">1</span>  | <span class="pl-c1">2686102</span>  | <span class="pl-c1">7249</span>       | <span class="pl-k">UPDATE</span> sbtest1 <span class="pl-k">SET</span> c<span class="pl-k">=</span>? <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>?                                    |
| <span class="pl-c1">1</span>  | <span class="pl-c1">2428829</span>  | <span class="pl-c1">7249</span>       | <span class="pl-k">DELETE</span> <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>?                                       |
| <span class="pl-c1">1</span>  | <span class="pl-c1">2260129</span>  | <span class="pl-c1">7249</span>       | <span class="pl-k">INSERT INTO</span> sbtest1 (id, k, c, pad) <span class="pl-k">VALUES</span> (?, ?, ?, ?)              |
| <span class="pl-c1">1</span>  | <span class="pl-c1">1921940</span>  | <span class="pl-c1">7249</span>       | <span class="pl-k">BEGIN</span>                                                                |
| <span class="pl-c1">1</span>  | <span class="pl-c1">1217</span>     | <span class="pl-c1">1</span>          | <span class="pl-k">SELECT</span> ?                                                             |
| <span class="pl-c1">1</span>  | <span class="pl-c1">273</span>      | <span class="pl-c1">1</span>          | <span class="pl-k">SELECT</span> @@port                                                        |
| <span class="pl-c1">1</span>  | <span class="pl-c1">0</span>        | <span class="pl-c1">2</span>          | <span class="pl-k">select</span> @@version_comment <span class="pl-k">limit</span> ?                                     |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>--+----------+------------+----------------------------------------------------------------------+</span>
<span class="pl-c1">14</span> rows <span class="pl-k">in</span> <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<p>All traffic is sent to hostgroup1. Let's assume that now we want to send specific queries to slaves...</p>
<h2>
<a aria-hidden="true" class="anchor" href="#mysql-query-rules" id="user-content-mysql-query-rules"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>MySQL Query Rules</h2>
<p>Table <code>mysql_query_rules</code> has a lot of fields and it is a very powerful vehicle to control the traffic passing through ProxySQL.
Its table definition is as follows:</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> SHOW CREATE TABLE mysql_query_rules\G
<span class="pl-k">***************************</span> <span class="pl-c1">1</span>. row <span class="pl-k">***************************</span>
       table: mysql_query_rules
Create Table: CREATE TABLE mysql_query_rules (
rule_id <span class="pl-k">INTEGER</span> <span class="pl-k">PRIMARY KEY</span> AUTOINCREMENT <span class="pl-k">NOT NULL</span>,
active <span class="pl-k">INT</span> <span class="pl-k">CHECK</span> (active <span class="pl-k">IN</span> (<span class="pl-c1">0</span>,<span class="pl-c1">1</span>)) <span class="pl-k">NOT NULL</span> DEFAULT <span class="pl-c1">0</span>,
username <span class="pl-k">VARCHAR</span>,
schemaname <span class="pl-k">VARCHAR</span>,
flagIN <span class="pl-k">INT</span> <span class="pl-k">NOT NULL</span> DEFAULT <span class="pl-c1">0</span>,
match_digest <span class="pl-k">VARCHAR</span>,
match_pattern <span class="pl-k">VARCHAR</span>,
negate_match_pattern <span class="pl-k">INT</span> <span class="pl-k">CHECK</span> (negate_match_pattern <span class="pl-k">IN</span> (<span class="pl-c1">0</span>,<span class="pl-c1">1</span>)) <span class="pl-k">NOT NULL</span> DEFAULT <span class="pl-c1">0</span>,
flagOUT <span class="pl-k">INT</span>,
replace_pattern <span class="pl-k">VARCHAR</span>,
destination_hostgroup <span class="pl-k">INT</span> DEFAULT <span class="pl-k">NULL</span>,
cache_ttl <span class="pl-k">INT</span> <span class="pl-k">CHECK</span>(cache_ttl <span class="pl-k">&gt;</span> <span class="pl-c1">0</span>),
reconnect <span class="pl-k">INT</span> <span class="pl-k">CHECK</span> (reconnect <span class="pl-k">IN</span> (<span class="pl-c1">0</span>,<span class="pl-c1">1</span>)) DEFAULT <span class="pl-k">NULL</span>,
timeout <span class="pl-k">INT</span> UNSIGNED,
delay <span class="pl-k">INT</span> UNSIGNED,
error_msg <span class="pl-k">VARCHAR</span>,
apply <span class="pl-k">INT</span> <span class="pl-k">CHECK</span>(apply <span class="pl-k">IN</span> (<span class="pl-c1">0</span>,<span class="pl-c1">1</span>)) <span class="pl-k">NOT NULL</span> DEFAULT <span class="pl-c1">0</span>)
<span class="pl-c1">1</span> row <span class="pl-k">in</span> <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">01</span> sec)</pre></div>
<p>We can now configure ProxySQL to send the top 2 queries to slaves, and everything else to the masters</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> <span class="pl-k">INSERT INTO</span> mysql_query_rules (rule_id,active,username,match_digest,destination_hostgroup,apply) <span class="pl-k">VALUES</span> (<span class="pl-c1">10</span>,<span class="pl-c1">1</span>,<span class="pl-s"><span class="pl-pds">'</span>msandbox<span class="pl-pds">'</span></span>,<span class="pl-s"><span class="pl-pds">'</span>^SELECT c FROM sbtest1 WHERE id=<span class="pl-cce">\?</span>$<span class="pl-pds">'</span></span>,<span class="pl-c1">2</span>,<span class="pl-c1">1</span>);
Query OK, <span class="pl-c1">1</span> row affected (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)

Admin<span class="pl-k">&gt;</span> <span class="pl-k">INSERT INTO</span> mysql_query_rules (rule_id,active,username,match_digest,destination_hostgroup,apply) <span class="pl-k">VALUES</span> (<span class="pl-c1">20</span>,<span class="pl-c1">1</span>,<span class="pl-s"><span class="pl-pds">'</span>msandbox<span class="pl-pds">'</span></span>,<span class="pl-s"><span class="pl-pds">'</span>DISTINCT c FROM sbtest1<span class="pl-pds">'</span></span>,<span class="pl-c1">2</span>,<span class="pl-c1">1</span>);
Query OK, <span class="pl-c1">1</span> row affected (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<p>Few notes:</p>
<ul>
<li>query rules are processed ordered by <code>rule_id</code>
</li>
<li>only rules that have <code>active=1</code> are processed. Because query rules are a very powerful tool and if misconfigured can lead to difficult debugging (we all love regex, right?) , by default active is 0 (<code>active=0</code>) . You should double check rules regexes before enabling them!</li>
<li>the first rule example uses caret (<code>^</code>) and dollar (<code>$</code>) : these are special regex characters that mark the beginning and the end of a pattern. In that case it means that <code>match_digest</code> or <code>match_pattern</code> should completely match the query</li>
<li>by contrast of the first rule example, the second rule example doesn't use caret or dollar : the match could be anywhere in the query</li>
<li>pay a lot of attention to regex to avoid that some rule matches what it shouldn't !</li>
<li>you probably notice that the question mark is escaped. It has a special meaning in regex, so as said, pay really a lot of attention to regex syntax !</li>
<li>
<code>apply=1</code> means that no further rules are checked if there is a match</li>
</ul>
<p>Table <code>mysql_query_rules</code> looks like:</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> match_digest,destination_hostgroup <span class="pl-k">FROM</span> mysql_query_rules <span class="pl-k">WHERE</span> active<span class="pl-k">=</span><span class="pl-c1">1</span> <span class="pl-k">AND</span> username<span class="pl-k">=</span><span class="pl-s"><span class="pl-pds">'</span>msandbox<span class="pl-pds">'</span></span> <span class="pl-k">ORDER BY</span> rule_id;
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>-----------------------------------+-----------------------+</span>
| match_digest                        | destination_hostgroup |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>-----------------------------------+-----------------------+</span>
| ^<span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>\?$ | <span class="pl-c1">2</span>                     |
| DISTINCT c <span class="pl-k">FROM</span> sbtest1             | <span class="pl-c1">2</span>                     |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>-----------------------------------+-----------------------+</span>
<span class="pl-c1">2</span> rows <span class="pl-k">in</span> <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<p>For these 2 specific rules, queries will be sent to slaves.
If no rules match a query, <code>default_hostgroup</code> applies (that is 1 for user msandbox).</p>
<p>Next, let's reset the content of the table <code>stats_mysql_query_digest</code> . To achieve this we can simply run any query against <code>stats_mysql_query_digest_reset</code> , for example:</p>
<div class="highlight highlight-source-sql"><pre><span class="pl-k">SELECT</span> <span class="pl-k">*</span> <span class="pl-k">FROM</span> stats_mysql_query_digest_reset <span class="pl-k">LIMIT</span> <span class="pl-c1">1</span>;</pre></div>
<p>Querying <code>stats_mysql_query_digest_reset</code> allows to atomically get the content of the <code>stats_mysql_query_digest</code> table , and truncate it!</p>
<p>Now we can load the query rules at runtime :</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> LOAD MYSQL QUERY RULES TO RUNTIME;
Query OK, <span class="pl-c1">0</span> rows affected (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<p>And finally we re-execute the sysbench load:</p>
<pre><code>vagrant@ubuntu-14:~/sysbench/sysbench-0.5/sysbench$ ./sysbench --report-interval=5 --num-threads=4 --max-requests=0 --max-time=20 --test=tests/db/oltp.lua --mysql-user='msandbox' --mysql-password='msandbox' --oltp-table-size=10000 --mysql-host=127.0.0.1 --mysql-port=6033 run
</code></pre>
<p>And let's verify the content of table <code>stats_mysql_query_digest</code> :</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> hostgroup hg, sum_time, count_star, digest_text <span class="pl-k">FROM</span> stats_mysql_query_digest <span class="pl-k">ORDER BY</span> sum_time <span class="pl-k">DESC</span>;
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>--+----------+------------+----------------------------------------------------------------------+</span>
| hg | sum_time | count_star | digest_text                                                          |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>--+----------+------------+----------------------------------------------------------------------+</span>
| <span class="pl-c1">2</span>  | <span class="pl-c1">14520738</span> | <span class="pl-c1">50041</span>      | <span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>?                                     |
| <span class="pl-c1">2</span>  | <span class="pl-c1">3203582</span>  | <span class="pl-c1">5001</span>       | <span class="pl-k">SELECT DISTINCT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id BETWEEN ? <span class="pl-k">AND</span> ?<span class="pl-k">+</span>? <span class="pl-k">ORDER BY</span> c |
| <span class="pl-c1">1</span>  | <span class="pl-c1">3142041</span>  | <span class="pl-c1">5001</span>       | <span class="pl-k">COMMIT</span>                                                               |
| <span class="pl-c1">1</span>  | <span class="pl-c1">2270931</span>  | <span class="pl-c1">5001</span>       | <span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id BETWEEN ? <span class="pl-k">AND</span> ?<span class="pl-k">+</span>? <span class="pl-k">ORDER BY</span> c          |
| <span class="pl-c1">1</span>  | <span class="pl-c1">2021320</span>  | <span class="pl-c1">5003</span>       | <span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id BETWEEN ? <span class="pl-k">AND</span> ?<span class="pl-k">+</span>?                     |
| <span class="pl-c1">1</span>  | <span class="pl-c1">1768748</span>  | <span class="pl-c1">5001</span>       | <span class="pl-k">UPDATE</span> sbtest1 <span class="pl-k">SET</span> k<span class="pl-k">=</span>k<span class="pl-k">+</span>? <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>?                                  |
| <span class="pl-c1">1</span>  | <span class="pl-c1">1697175</span>  | <span class="pl-c1">5003</span>       | <span class="pl-k">SELECT</span> <span class="pl-c1">SUM</span>(K) <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id BETWEEN ? <span class="pl-k">AND</span> ?<span class="pl-k">+</span>?                |
| <span class="pl-c1">1</span>  | <span class="pl-c1">1346791</span>  | <span class="pl-c1">5001</span>       | <span class="pl-k">UPDATE</span> sbtest1 <span class="pl-k">SET</span> c<span class="pl-k">=</span>? <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>?                                    |
| <span class="pl-c1">1</span>  | <span class="pl-c1">1263259</span>  | <span class="pl-c1">5001</span>       | <span class="pl-k">DELETE</span> <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>?                                       |
| <span class="pl-c1">1</span>  | <span class="pl-c1">1191760</span>  | <span class="pl-c1">5001</span>       | <span class="pl-k">INSERT INTO</span> sbtest1 (id, k, c, pad) <span class="pl-k">VALUES</span> (?, ?, ?, ?)              |
| <span class="pl-c1">1</span>  | <span class="pl-c1">875343</span>   | <span class="pl-c1">5005</span>       | <span class="pl-k">BEGIN</span>                                                                |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>--+----------+------------+----------------------------------------------------------------------+</span>
<span class="pl-c1">11</span> rows <span class="pl-k">in</span> <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<p>As expected, the top 2 queries are not sent to hostgroup2 (the slaves).
Table <code>stats_mysql_query_digest</code> allows to aggregate results, for example:</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> hostgroup hg, <span class="pl-c1">SUM</span>(sum_time), <span class="pl-c1">SUM</span>(count_star) <span class="pl-k">FROM</span> stats_mysql_query_digest <span class="pl-k">GROUP BY</span> hostgroup;
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>--+---------------+-----------------+</span>
| hg | <span class="pl-c1">SUM</span>(sum_time) | <span class="pl-c1">SUM</span>(count_star) |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>--+---------------+-----------------+</span>
| <span class="pl-c1">1</span>  | <span class="pl-c1">21523008</span>      | <span class="pl-c1">59256</span>           |
| <span class="pl-c1">2</span>  | <span class="pl-c1">23915965</span>      | <span class="pl-c1">72424</span>           |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>--+---------------+-----------------+</span>
<span class="pl-c1">2</span> rows <span class="pl-k">in</span> <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<h2>
<a aria-hidden="true" class="anchor" href="#query-caching" id="user-content-query-caching"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Query Caching</h2>
<p>A popular use of ProxySQL is to act as a query cache. By default, queries aren't cached, but it can be enabled setting <code>cache_ttl</code> (in milliseconds) in <code>mysql_query_rules</code> .</p>
<p>Assume we want to also cache for 5 seconds all the queries sent to slaves.</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> <span class="pl-k">UPDATE</span> mysql_query_rules <span class="pl-k">set</span> cache_ttl<span class="pl-k">=</span><span class="pl-c1">5000</span> <span class="pl-k">WHERE</span> active<span class="pl-k">=</span><span class="pl-c1">1</span> <span class="pl-k">AND</span> destination_hostgroup<span class="pl-k">=</span><span class="pl-c1">2</span>;
Query OK, <span class="pl-c1">2</span> rows affected (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)

Admin<span class="pl-k">&gt;</span> LOAD MYSQL QUERY RULES TO RUNTIME;
Query OK, <span class="pl-c1">0</span> rows affected (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)

Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> <span class="pl-c1">1</span> <span class="pl-k">FROM</span> stats_mysql_query_digest_reset <span class="pl-k">LIMIT</span> <span class="pl-c1">1</span>; <span class="pl-c"><span class="pl-c">--</span> we reset the counters</span>
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>-+</span>
| <span class="pl-c1">1</span> |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>-+</span>
| <span class="pl-c1">1</span> |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>-+</span>
<span class="pl-c1">1</span> row <span class="pl-k">in</span> <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<p>Now, we can run again the load test:</p>
<pre><code>vagrant@ubuntu-14:~/sysbench/sysbench-0.5/sysbench$ ./sysbench --report-interval=5 --num-threads=4 --max-requests=0 --max-time=20 --test=tests/db/oltp.lua --mysql-user='msandbox' --mysql-password='msandbox' --oltp-table-size=10000 --mysql-host=127.0.0.1 --mysql-port=6033 run
</code></pre>
<p>We can now verify the content of table <code>stats_mysql_query_digest</code> :</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> hostgroup hg, sum_time, count_star, digest_text <span class="pl-k">FROM</span> stats_mysql_query_digest <span class="pl-k">ORDER BY</span> sum_time <span class="pl-k">DESC</span>;
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>--+----------+------------+----------------------------------------------------------------------+</span>
| hg | sum_time | count_star | digest_text                                                          |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>--+----------+------------+----------------------------------------------------------------------+</span>
| <span class="pl-c1">1</span>  | <span class="pl-c1">7457441</span>  | <span class="pl-c1">5963</span>       | <span class="pl-k">COMMIT</span>                                                               |
| <span class="pl-c1">1</span>  | <span class="pl-c1">6767681</span>  | <span class="pl-c1">5963</span>       | <span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id BETWEEN ? <span class="pl-k">AND</span> ?<span class="pl-k">+</span>? <span class="pl-k">ORDER BY</span> c          |
| <span class="pl-c1">2</span>  | <span class="pl-c1">4891464</span>  | <span class="pl-c1">8369</span>       | <span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>?                                     |
| <span class="pl-c1">1</span>  | <span class="pl-c1">4573513</span>  | <span class="pl-c1">5963</span>       | <span class="pl-k">UPDATE</span> sbtest1 <span class="pl-k">SET</span> k<span class="pl-k">=</span>k<span class="pl-k">+</span>? <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>?                                  |
| <span class="pl-c1">1</span>  | <span class="pl-c1">4531319</span>  | <span class="pl-c1">5963</span>       | <span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id BETWEEN ? <span class="pl-k">AND</span> ?<span class="pl-k">+</span>?                     |
| <span class="pl-c1">1</span>  | <span class="pl-c1">3993283</span>  | <span class="pl-c1">5963</span>       | <span class="pl-k">SELECT</span> <span class="pl-c1">SUM</span>(K) <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id BETWEEN ? <span class="pl-k">AND</span> ?<span class="pl-k">+</span>?                |
| <span class="pl-c1">1</span>  | <span class="pl-c1">3482242</span>  | <span class="pl-c1">5963</span>       | <span class="pl-k">UPDATE</span> sbtest1 <span class="pl-k">SET</span> c<span class="pl-k">=</span>? <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>?                                    |
| <span class="pl-c1">1</span>  | <span class="pl-c1">3209088</span>  | <span class="pl-c1">5963</span>       | <span class="pl-k">DELETE</span> <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>?                                       |
| <span class="pl-c1">1</span>  | <span class="pl-c1">2959358</span>  | <span class="pl-c1">5963</span>       | <span class="pl-k">INSERT INTO</span> sbtest1 (id, k, c, pad) <span class="pl-k">VALUES</span> (?, ?, ?, ?)              |
| <span class="pl-c1">1</span>  | <span class="pl-c1">2415318</span>  | <span class="pl-c1">5963</span>       | <span class="pl-k">BEGIN</span>                                                                |
| <span class="pl-c1">2</span>  | <span class="pl-c1">2266662</span>  | <span class="pl-c1">1881</span>       | <span class="pl-k">SELECT DISTINCT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id BETWEEN ? <span class="pl-k">AND</span> ?<span class="pl-k">+</span>? <span class="pl-k">ORDER BY</span> c |
| <span class="pl-k">-</span><span class="pl-c1">1</span> | <span class="pl-c1">0</span>        | <span class="pl-c1">4082</span>       | <span class="pl-k">SELECT DISTINCT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id BETWEEN ? <span class="pl-k">AND</span> ?<span class="pl-k">+</span>? <span class="pl-k">ORDER BY</span> c |
| <span class="pl-k">-</span><span class="pl-c1">1</span> | <span class="pl-c1">0</span>        | <span class="pl-c1">51261</span>      | <span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>?                                     |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>--+----------+------------+----------------------------------------------------------------------+</span>
<span class="pl-c1">13</span> rows <span class="pl-k">in</span> <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<p>It is possible to see that what used to be the top 2 queries and being sent to the hostgroup2 , now:</p>
<ul>
<li>they are still sent to hostgroup2</li>
<li>if they present in the query cache, they aren’t sent to any hostgroup and marked with a special hostgroup -1</li>
<li>tthe total execution time for the queries cached is 0 (this means that the request was served within the same events loop</li>
</ul>
<p>Note: currently it is not possible to define the maximum amount of memory used by the query cache, neither is possible to force a selective or complete flush of the query cache.
Right now, it is possible to control the memory footprint and the life of result set only through <code>cache_ttl</code> in <code>mysql_query_rules</code> : choose <code>cache_ttl</code> wisely until more control over query cache will be available.</p>
<h2>
<a aria-hidden="true" class="anchor" href="#query-rewrite" id="user-content-query-rewrite"><svg aria-hidden="true" class="octicon octicon-link" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z" fill-rule="evenodd"></path></svg></a>Query Rewrite</h2>
<p>ProxySQL supports multiple ways to match a query, like <code>flagIN</code>, <code>username</code>, <code>schemaname</code>.</p>
<p>The most common way to match a query is writing a regular expression that matches the text of the query itself.
To match the text of a query ProxySQL provides 2 mechanisms, using 2 different fields:</p>
<ul>
<li>
<code>match_digest</code> : it matches the regular expression again the digest of the query, as represented in <code>stats_mysql_query_digest.query_digest</code>
</li>
<li>
<code>match_pattern</code> : it matches the regular expression again the unmodified text of the query</li>
</ul>
<p>Why those different mechanism? The digest of a query can be extremely smaller than the query itself (for example, an <code>INSERT</code> statement with several MB of data), thus running a regex against a smaller string is surely faster.
So, in case you aren't trying to match a specific literal in the query, it is recommended (faster) to use <code>match_digest</code> .</p>
<p>Although, if you want to rewrite queries, you must match against the original query (using <code>match_pattern</code>), because it is the original query that needs to be rewritten.</p>
<p>An example:</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> <span class="pl-k">INSERT INTO</span> mysql_query_rules (rule_id,active,username,match_pattern,replace_pattern,apply) <span class="pl-k">VALUES</span> (<span class="pl-c1">30</span>,<span class="pl-c1">1</span>,<span class="pl-s"><span class="pl-pds">'</span>msandbox<span class="pl-pds">'</span></span>,<span class="pl-s"><span class="pl-pds">'</span>DISTINCT(.*)ORDER BY c<span class="pl-pds">'</span></span>,<span class="pl-s"><span class="pl-pds">'</span>DISTINCT<span class="pl-cce">\1</span><span class="pl-pds">'</span></span>,<span class="pl-c1">1</span>);
Query OK, <span class="pl-c1">1</span> row affected (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)


Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> rule_id, match_digest, match_pattern, replace_pattern, cache_ttl, apply <span class="pl-k">FROM</span> mysql_query_rules <span class="pl-k">ORDER BY</span> rule_id;
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>-------+-------------------------------------+------------------------+-----------------+-----------+-------+</span>
| rule_id | match_digest                        | match_pattern          | replace_pattern | cache_ttl | apply |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>-------+-------------------------------------+------------------------+-----------------+-----------+-------+</span>
| <span class="pl-c1">10</span>      | ^<span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>\?$ | <span class="pl-k">NULL</span>                   | <span class="pl-k">NULL</span>            | <span class="pl-c1">5000</span>      | <span class="pl-c1">1</span>     |
| <span class="pl-c1">20</span>      | DISTINCT c <span class="pl-k">FROM</span> sbtest1             | <span class="pl-k">NULL</span>                   | <span class="pl-k">NULL</span>            | <span class="pl-c1">5000</span>      | <span class="pl-c1">1</span>     |
| <span class="pl-c1">30</span>      | <span class="pl-k">NULL</span>                                | DISTINCT(.<span class="pl-k">*</span>)<span class="pl-k">ORDER BY</span> c | DISTINCT\<span class="pl-c1">1</span>      | <span class="pl-k">NULL</span>      | <span class="pl-c1">1</span>     |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>-------+-------------------------------------+------------------------+-----------------+-----------+-------+</span>
<span class="pl-c1">3</span> rows <span class="pl-k">in</span> <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)


Admin<span class="pl-k">&gt;</span> LOAD MYSQL QUERY RULES TO RUNTIME;
Query OK, <span class="pl-c1">0</span> rows affected (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<p>Let's try this new rules.</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> <span class="pl-c1">1</span> <span class="pl-k">FROM</span> stats_mysql_query_digest_reset <span class="pl-k">LIMIT</span> <span class="pl-c1">1</span>;</pre></div>
<pre><code>vagrant@ubuntu-14:~/sysbench/sysbench-0.5/sysbench$ ./sysbench --report-interval=5 --num-threads=4 --max-requests=0 --max-time=20 --test=tests/db/oltp.lua  --mysql-user='msandbox' --mysql-password='msandbox' --oltp-table-size=10000 --mysql-host=127.0.0.1 --mysql-port=6033 run
</code></pre>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> hostgroup hg, sum_time, count_star, digest_text <span class="pl-k">FROM</span> stats_mysql_query_digest <span class="pl-k">ORDER BY</span> sum_time <span class="pl-k">DESC</span>;
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>--+----------+------------+----------------------------------------------------------------------+</span>
| hg | sum_time | count_star | digest_text                                                          |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>--+----------+------------+----------------------------------------------------------------------+</span>
| <span class="pl-c1">1</span>  | <span class="pl-c1">8150528</span>  | <span class="pl-c1">5307</span>       | <span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id BETWEEN ? <span class="pl-k">AND</span> ?<span class="pl-k">+</span>? <span class="pl-k">ORDER BY</span> c          |
| <span class="pl-c1">1</span>  | <span class="pl-c1">7341765</span>  | <span class="pl-c1">5304</span>       | <span class="pl-k">COMMIT</span>                                                               |
| <span class="pl-c1">2</span>  | <span class="pl-c1">5717866</span>  | <span class="pl-c1">7860</span>       | <span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>?                                     |
| <span class="pl-c1">1</span>  | <span class="pl-c1">4807609</span>  | <span class="pl-c1">5307</span>       | <span class="pl-k">UPDATE</span> sbtest1 <span class="pl-k">SET</span> k<span class="pl-k">=</span>k<span class="pl-k">+</span>? <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>?                                  |
| <span class="pl-c1">1</span>  | <span class="pl-c1">4164131</span>  | <span class="pl-c1">5308</span>       | <span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id BETWEEN ? <span class="pl-k">AND</span> ?<span class="pl-k">+</span>?                     |
| <span class="pl-c1">1</span>  | <span class="pl-c1">3731299</span>  | <span class="pl-c1">5307</span>       | <span class="pl-k">SELECT</span> <span class="pl-c1">SUM</span>(K) <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id BETWEEN ? <span class="pl-k">AND</span> ?<span class="pl-k">+</span>?                |
| <span class="pl-c1">1</span>  | <span class="pl-c1">3156638</span>  | <span class="pl-c1">5305</span>       | <span class="pl-k">DELETE</span> <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>?                                       |
| <span class="pl-c1">1</span>  | <span class="pl-c1">3074430</span>  | <span class="pl-c1">5306</span>       | <span class="pl-k">UPDATE</span> sbtest1 <span class="pl-k">SET</span> c<span class="pl-k">=</span>? <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>?                                    |
| <span class="pl-c1">2</span>  | <span class="pl-c1">2857863</span>  | <span class="pl-c1">1705</span>       | <span class="pl-k">SELECT DISTINCT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id BETWEEN ? <span class="pl-k">AND</span> ?<span class="pl-k">+</span>? <span class="pl-k">ORDER BY</span> c |
| <span class="pl-c1">1</span>  | <span class="pl-c1">2732332</span>  | <span class="pl-c1">5304</span>       | <span class="pl-k">INSERT INTO</span> sbtest1 (id, k, c, pad) <span class="pl-k">VALUES</span> (?, ?, ?, ?)              |
| <span class="pl-c1">1</span>  | <span class="pl-c1">2165367</span>  | <span class="pl-c1">5310</span>       | <span class="pl-k">BEGIN</span>                                                                |
| <span class="pl-k">-</span><span class="pl-c1">1</span> | <span class="pl-c1">0</span>        | <span class="pl-c1">3602</span>       | <span class="pl-k">SELECT DISTINCT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id BETWEEN ? <span class="pl-k">AND</span> ?<span class="pl-k">+</span>? <span class="pl-k">ORDER BY</span> c |
| <span class="pl-k">-</span><span class="pl-c1">1</span> | <span class="pl-c1">0</span>        | <span class="pl-c1">45235</span>      | <span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>?                                     |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>--+----------+------------+----------------------------------------------------------------------+</span>
<span class="pl-c1">13</span> rows <span class="pl-k">in</span> <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<p>Something looks wrong, as no rewrite seems to have happened.
This is intentional, so we can now troubleshoot.
A very useful table for troubleshooting is <code>stats.stats_mysql_query_rules</code> :</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> hits, <span class="pl-c1">mysql_query_rules</span>.<span class="pl-c1">rule_id</span>, match_digest, match_pattern, replace_pattern, cache_ttl, apply <span class="pl-k">FROM</span> mysql_query_rules <span class="pl-k">NATURAL JOIN</span> <span class="pl-c1">stats</span>.<span class="pl-c1">stats_mysql_query_rules</span> <span class="pl-k">ORDER BY</span> <span class="pl-c1">mysql_query_rules</span>.<span class="pl-c1">rule_id</span>;
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>-----+---------+-------------------------------------+------------------------+-----------------+-----------+-------+</span>
| hits  | rule_id | match_digest                        | match_pattern          | replace_pattern | cache_ttl | apply |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>-----+---------+-------------------------------------+------------------------+-----------------+-----------+-------+</span>
| <span class="pl-c1">54670</span> | <span class="pl-c1">10</span>      | ^<span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>\?$ | <span class="pl-k">NULL</span>                   | <span class="pl-k">NULL</span>            | <span class="pl-c1">5000</span>      | <span class="pl-c1">1</span>     |
| <span class="pl-c1">5467</span>  | <span class="pl-c1">20</span>      | DISTINCT c <span class="pl-k">FROM</span> sbtest1             | <span class="pl-k">NULL</span>                   | <span class="pl-k">NULL</span>            | <span class="pl-c1">5000</span>      | <span class="pl-c1">1</span>     |
| <span class="pl-c1">0</span>     | <span class="pl-c1">30</span>      | <span class="pl-k">NULL</span>                                | DISTINCT(.<span class="pl-k">*</span>)<span class="pl-k">ORDER BY</span> c | DISTINCT\<span class="pl-c1">1</span>      | <span class="pl-k">NULL</span>      | <span class="pl-c1">1</span>     |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>-----+---------+-------------------------------------+------------------------+-----------------+-----------+-------+</span>
<span class="pl-c1">3</span> rows <span class="pl-k">in</span> <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">01</span> sec)</pre></div>
<p>It seems clear something is wrong: rule with <code>rule_id=30</code> has 0 hits!</p>
<p>The problem is that rule with <code>rule_id=20</code> also matches queries that would match in <code>rule_id=30</code> , although <code>apply=1</code> in rule number 20 will prevent to reach rule number 30.
Let fix this:</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> <span class="pl-k">UPDATE</span> mysql_query_rules <span class="pl-k">SET</span> apply<span class="pl-k">=</span><span class="pl-c1">0</span> <span class="pl-k">WHERE</span> rule_id<span class="pl-k">=</span><span class="pl-c1">20</span>;
Query OK, <span class="pl-c1">1</span> row affected (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)

Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> rule_id, match_digest, match_pattern, replace_pattern, cache_ttl, apply <span class="pl-k">FROM</span> mysql_query_rules <span class="pl-k">ORDER BY</span> rule_id;
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>-------+-------------------------------------+------------------------+-----------------+-----------+-------+</span>
| rule_id | match_digest                        | match_pattern          | replace_pattern | cache_ttl | apply |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>-------+-------------------------------------+------------------------+-----------------+-----------+-------+</span>
| <span class="pl-c1">10</span>      | ^<span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>\?$ | <span class="pl-k">NULL</span>                   | <span class="pl-k">NULL</span>            | <span class="pl-c1">5000</span>      | <span class="pl-c1">1</span>     |
| <span class="pl-c1">20</span>      | DISTINCT c <span class="pl-k">FROM</span> sbtest1             | <span class="pl-k">NULL</span>                   | <span class="pl-k">NULL</span>            | <span class="pl-c1">5000</span>      | <span class="pl-c1">0</span>     |
| <span class="pl-c1">30</span>      | <span class="pl-k">NULL</span>                                | DISTINCT(.<span class="pl-k">*</span>)<span class="pl-k">ORDER BY</span> c | DISTINCT\<span class="pl-c1">1</span>      | <span class="pl-k">NULL</span>      | <span class="pl-c1">1</span>     |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>-------+-------------------------------------+------------------------+-----------------+-----------+-------+</span>
<span class="pl-c1">3</span> rows <span class="pl-k">in</span> <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<p>Now should work!
Let's load the rules again:</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> LOAD MYSQL QUERY RULES TO RUNTIME;
Query OK, <span class="pl-c1">0</span> rows affected (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<p>Note: when running <code>LOAD MYSQL QUERY RULES TO RUNTIME</code> not only internal query processing structures are reset, but also the counters in <code>stats.stats_mysql_query_rules</code> :</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> <span class="pl-k">*</span> <span class="pl-k">FROM</span> <span class="pl-c1">stats</span>.<span class="pl-c1">stats_mysql_query_rules</span>;
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>-------+------+</span>
| rule_id | hits |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>-------+------+</span>
| <span class="pl-c1">10</span>      | <span class="pl-c1">0</span>    |
| <span class="pl-c1">20</span>      | <span class="pl-c1">0</span>    |
| <span class="pl-c1">30</span>      | <span class="pl-c1">0</span>    |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>-------+------+</span>
<span class="pl-c1">3</span> rows <span class="pl-k">in</span> <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<p>Let's try again:</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> <span class="pl-c1">1</span> <span class="pl-k">FROM</span> stats_mysql_query_digest_reset <span class="pl-k">LIMIT</span> <span class="pl-c1">1</span>;</pre></div>
<pre><code>vagrant@ubuntu-14:~/sysbench/sysbench-0.5/sysbench$ ./sysbench --report-interval=5 --num-threads=4 --max-requests=0 --max-time=20 --test=tests/db/oltp.lua --mysql-user='msandbox' --mysql-password='msandbox' --oltp-table-size=10000 --mysql-host=127.0.0.1 --mysql-port=6033 run
</code></pre>
<p>And now we can verify:</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> hits, <span class="pl-c1">mysql_query_rules</span>.<span class="pl-c1">rule_id</span>, match_digest, match_pattern, replace_pattern, cache_ttl, apply <span class="pl-k">FROM</span> mysql_query_rules <span class="pl-k">NATURAL JOIN</span> <span class="pl-c1">stats</span>.<span class="pl-c1">stats_mysql_query_rules</span> <span class="pl-k">ORDER BY</span> <span class="pl-c1">mysql_query_rules</span>.<span class="pl-c1">rule_id</span>;
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>-----+---------+-------------------------------------+------------------------+-----------------+-----------+-------+</span>
| hits  | rule_id | match_digest                        | match_pattern          | replace_pattern | cache_ttl | apply |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>-----+---------+-------------------------------------+------------------------+-----------------+-----------+-------+</span>
| <span class="pl-c1">48560</span> | <span class="pl-c1">10</span>      | ^<span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>\?$ | <span class="pl-k">NULL</span>                   | <span class="pl-k">NULL</span>            | <span class="pl-c1">5000</span>      | <span class="pl-c1">1</span>     |
| <span class="pl-c1">4856</span>  | <span class="pl-c1">20</span>      | DISTINCT c <span class="pl-k">FROM</span> sbtest1             | <span class="pl-k">NULL</span>                   | <span class="pl-k">NULL</span>            | <span class="pl-c1">5000</span>      | <span class="pl-c1">0</span>     |
| <span class="pl-c1">4856</span>  | <span class="pl-c1">30</span>      | <span class="pl-k">NULL</span>                                | DISTINCT(.<span class="pl-k">*</span>)<span class="pl-k">ORDER BY</span> c | DISTINCT\<span class="pl-c1">1</span>      | <span class="pl-k">NULL</span>      | <span class="pl-c1">1</span>     |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>-----+---------+-------------------------------------+------------------------+-----------------+-----------+-------+</span>
<span class="pl-c1">3</span> rows <span class="pl-k">in</span> <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">01</span> sec)</pre></div>
<p>There are rewrites, looks good :-)</p>
<p>What about query execution ?</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> hostgroup hg, sum_time, count_star, digest_text <span class="pl-k">FROM</span> stats_mysql_query_digest <span class="pl-k">ORDER BY</span> sum_time <span class="pl-k">DESC</span>;
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>--+----------+------------+-------------------------------------------------------------+</span>
| hg | sum_time | count_star | digest_text                                                 |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>--+----------+------------+-------------------------------------------------------------+</span>
| <span class="pl-c1">1</span>  | <span class="pl-c1">7240757</span>  | <span class="pl-c1">4856</span>       | <span class="pl-k">COMMIT</span>                                                      |
| <span class="pl-c1">1</span>  | <span class="pl-c1">6127168</span>  | <span class="pl-c1">4856</span>       | <span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id BETWEEN ? <span class="pl-k">AND</span> ?<span class="pl-k">+</span>? <span class="pl-k">ORDER BY</span> c |
| <span class="pl-c1">2</span>  | <span class="pl-c1">4264263</span>  | <span class="pl-c1">7359</span>       | <span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>?                            |
| <span class="pl-c1">1</span>  | <span class="pl-c1">4081063</span>  | <span class="pl-c1">4856</span>       | <span class="pl-k">UPDATE</span> sbtest1 <span class="pl-k">SET</span> k<span class="pl-k">=</span>k<span class="pl-k">+</span>? <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>?                         |
| <span class="pl-c1">1</span>  | <span class="pl-c1">3497644</span>  | <span class="pl-c1">4856</span>       | <span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id BETWEEN ? <span class="pl-k">AND</span> ?<span class="pl-k">+</span>?            |
| <span class="pl-c1">1</span>  | <span class="pl-c1">3270527</span>  | <span class="pl-c1">4856</span>       | <span class="pl-k">DELETE</span> <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>?                              |
| <span class="pl-c1">1</span>  | <span class="pl-c1">3193123</span>  | <span class="pl-c1">4856</span>       | <span class="pl-k">SELECT</span> <span class="pl-c1">SUM</span>(K) <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id BETWEEN ? <span class="pl-k">AND</span> ?<span class="pl-k">+</span>?       |
| <span class="pl-c1">1</span>  | <span class="pl-c1">3124698</span>  | <span class="pl-c1">4856</span>       | <span class="pl-k">UPDATE</span> sbtest1 <span class="pl-k">SET</span> c<span class="pl-k">=</span>? <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>?                           |
| <span class="pl-c1">1</span>  | <span class="pl-c1">2866474</span>  | <span class="pl-c1">4856</span>       | <span class="pl-k">INSERT INTO</span> sbtest1 (id, k, c, pad) <span class="pl-k">VALUES</span> (?, ?, ?, ?)     |
| <span class="pl-c1">1</span>  | <span class="pl-c1">2538840</span>  | <span class="pl-c1">4856</span>       | <span class="pl-k">BEGIN</span>                                                       |
| <span class="pl-c1">2</span>  | <span class="pl-c1">1889996</span>  | <span class="pl-c1">1633</span>       | <span class="pl-k">SELECT DISTINCT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id BETWEEN ? <span class="pl-k">AND</span> ?<span class="pl-k">+</span>?   |
| <span class="pl-k">-</span><span class="pl-c1">1</span> | <span class="pl-c1">0</span>        | <span class="pl-c1">3223</span>       | <span class="pl-k">SELECT DISTINCT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id BETWEEN ? <span class="pl-k">AND</span> ?<span class="pl-k">+</span>?   |
| <span class="pl-k">-</span><span class="pl-c1">1</span> | <span class="pl-c1">0</span>        | <span class="pl-c1">41201</span>      | <span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>?                            |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>--+----------+------------+-------------------------------------------------------------+</span>
<span class="pl-c1">13</span> rows <span class="pl-k">in</span> <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<p>Note:
Rules with <code>rule_id=20</code> and <code>rule_id=30</code> can be merged together into a single rule.
They are separated to describe the importance of <code>apply</code> field, and that not only multiple rules can match the same query, but multiple rules can transform and apply settings to the same query.</p>
<p>Few more example of query rewrite.</p>
<p>We want to rewrite queries like:</p>
<div class="highlight highlight-source-sql"><pre><span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>?</pre></div>
<p>into:</p>
<div class="highlight highlight-source-sql"><pre><span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest2 <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>?</pre></div>
<p>But only for ids between 1000 and 3999 ...
I know, this makes no sense, it is just to show some potentials, including the ability some complex sharding!!</p>
<p>How this looks in regex? :-)</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> <span class="pl-k">INSERT INTO</span> mysql_query_rules (rule_id,active,username,match_pattern,replace_pattern,apply) <span class="pl-k">VALUES</span> (<span class="pl-c1">5</span>,<span class="pl-c1">1</span>,<span class="pl-s"><span class="pl-pds">'</span>msandbox<span class="pl-pds">'</span></span>,<span class="pl-s"><span class="pl-pds">'</span>^SELECT (c) FROM sbtest(1) WHERE id=(1|2|3)(...)$<span class="pl-pds">'</span></span>,<span class="pl-s"><span class="pl-pds">'</span>SELECT c FROM sbtest2 WHERE id=<span class="pl-cce">\3\4</span><span class="pl-pds">'</span></span>,<span class="pl-c1">1</span>);
Query OK, <span class="pl-c1">1</span> row affected (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<p>Note that "c" and "1" (in sbtest1) are selected just to show the syntax</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> rule_id, match_digest, match_pattern, replace_pattern, cache_ttl, apply <span class="pl-k">FROM</span> mysql_query_rules <span class="pl-k">ORDER BY</span> rule_id;
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>-------+-------------------------------------+---------------------------------------------+------------------------------------+-----------+-------+</span>
| rule_id | match_digest                        | match_pattern                               | replace_pattern                    | cache_ttl | apply |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>-------+-------------------------------------+---------------------------------------------+------------------------------------+-----------+-------+</span>
| <span class="pl-c1">5</span>       | <span class="pl-k">NULL</span>                                | ^<span class="pl-k">SELECT</span> (c) <span class="pl-k">FROM</span> sbtest(<span class="pl-c1">1</span>) <span class="pl-k">WHERE</span> id<span class="pl-k">=</span><span class="pl-c1">1</span>(...)$ | <span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest2 <span class="pl-k">WHERE</span> id<span class="pl-k">=</span><span class="pl-c1">1</span>\<span class="pl-c1">3</span> | <span class="pl-k">NULL</span>      | <span class="pl-c1">1</span>     |
| <span class="pl-c1">10</span>      | ^<span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>\?$ | <span class="pl-k">NULL</span>                                        | <span class="pl-k">NULL</span>                               | <span class="pl-c1">5000</span>      | <span class="pl-c1">1</span>     |
| <span class="pl-c1">20</span>      | DISTINCT c <span class="pl-k">FROM</span> sbtest1             | <span class="pl-k">NULL</span>                                        | <span class="pl-k">NULL</span>                               | <span class="pl-c1">5000</span>      | <span class="pl-c1">0</span>     |
| <span class="pl-c1">30</span>      | <span class="pl-k">NULL</span>                                | DISTINCT(.<span class="pl-k">*</span>)<span class="pl-k">ORDER BY</span> c                      | DISTINCT\<span class="pl-c1">1</span>                         | <span class="pl-k">NULL</span>      | <span class="pl-c1">1</span>     |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>-------+-------------------------------------+---------------------------------------------+------------------------------------+-----------+-------+</span>
<span class="pl-c1">4</span> rows <span class="pl-k">in</span> <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<p>Let's try it.</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> <span class="pl-c1">1</span> <span class="pl-k">FROM</span> stats_mysql_query_digest_reset <span class="pl-k">LIMIT</span> <span class="pl-c1">1</span>;

Admin<span class="pl-k">&gt;</span> LOAD MYSQL QUERY RULES TO RUNTIME;
Query OK, <span class="pl-c1">0</span> rows affected (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)</pre></div>
<pre><code>vagrant@ubuntu-14:~/sysbench/sysbench-0.5/sysbench$ ./sysbench --report-interval=5 --num-threads=4 --max-requests=0 --max-time=20 --test=tests/db/oltp.lua --mysql-user='msandbox' --mysql-password='msandbox' --oltp-table-size=10000 --mysql-host=127.0.0.1 --mysql-port=6033 run
</code></pre>
<p>Did it work? Apparently yes :)</p>
<div class="highlight highlight-source-sql"><pre>Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> hits, <span class="pl-c1">mysql_query_rules</span>.<span class="pl-c1">rule_id</span>, match_digest, match_pattern, replace_pattern, cache_ttl, apply <span class="pl-k">FROM</span> mysql_query_rules <span class="pl-k">NATURAL JOIN</span> <span class="pl-c1">stats</span>.<span class="pl-c1">stats_mysql_query_rules</span>;                                              <span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>-----+---------+-------------------------------------+---------------------------------------------------+-------------------------------------+-----------+-------+</span>
| hits  | rule_id | match_digest                        | match_pattern                                     | replace_pattern                     | cache_ttl | apply |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>-----+---------+-------------------------------------+---------------------------------------------------+-------------------------------------+-----------+-------+</span>
| <span class="pl-c1">2579</span>  | <span class="pl-c1">5</span>       | <span class="pl-k">NULL</span>                                | ^<span class="pl-k">SELECT</span> (c) <span class="pl-k">FROM</span> sbtest(<span class="pl-c1">1</span>) <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>(<span class="pl-c1">1</span>|<span class="pl-c1">2</span>|<span class="pl-c1">3</span>)(...)$ | <span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest2 <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>\<span class="pl-c1">3</span>\<span class="pl-c1">4</span> | <span class="pl-k">NULL</span>      | <span class="pl-c1">1</span>     |
| <span class="pl-c1">83091</span> | <span class="pl-c1">10</span>      | ^<span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>\?$ | <span class="pl-k">NULL</span>                                              | <span class="pl-k">NULL</span>                                | <span class="pl-c1">5000</span>      | <span class="pl-c1">1</span>     |
| <span class="pl-c1">8567</span>  | <span class="pl-c1">20</span>      | DISTINCT c <span class="pl-k">FROM</span> sbtest1             | <span class="pl-k">NULL</span>                                              | <span class="pl-k">NULL</span>                                | <span class="pl-c1">5000</span>      | <span class="pl-c1">0</span>     |
| <span class="pl-c1">8567</span>  | <span class="pl-c1">30</span>      | <span class="pl-k">NULL</span>                                | DISTINCT(.<span class="pl-k">*</span>)<span class="pl-k">ORDER BY</span> c                            | DISTINCT\<span class="pl-c1">1</span>                          | <span class="pl-k">NULL</span>      | <span class="pl-c1">1</span>     |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>-----+---------+-------------------------------------+---------------------------------------------------+-------------------------------------+-----------+-------+</span>
<span class="pl-c1">4</span> rows <span class="pl-k">in</span> <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">00</span> sec)

Admin<span class="pl-k">&gt;</span> <span class="pl-k">SELECT</span> hostgroup hg, sum_time, count_star, digest_text <span class="pl-k">FROM</span> stats_mysql_query_digest <span class="pl-k">ORDER BY</span> sum_time <span class="pl-k">DESC</span>;
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>--+----------+------------+-------------------------------------------------------------+</span>
| hg | sum_time | count_star | digest_text                                                 |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>--+----------+------------+-------------------------------------------------------------+</span>
| <span class="pl-c1">1</span>  | <span class="pl-c1">9417428</span>  | <span class="pl-c1">8567</span>       | <span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id BETWEEN ? <span class="pl-k">AND</span> ?<span class="pl-k">+</span>? <span class="pl-k">ORDER BY</span> c |
| <span class="pl-c1">1</span>  | <span class="pl-c1">6282654</span>  | <span class="pl-c1">8567</span>       | <span class="pl-k">COMMIT</span>                                                      |
| <span class="pl-c1">1</span>  | <span class="pl-c1">5560850</span>  | <span class="pl-c1">8567</span>       | <span class="pl-k">UPDATE</span> sbtest1 <span class="pl-k">SET</span> k<span class="pl-k">=</span>k<span class="pl-k">+</span>? <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>?                         |
| <span class="pl-c1">1</span>  | <span class="pl-c1">5360637</span>  | <span class="pl-c1">8567</span>       | <span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id BETWEEN ? <span class="pl-k">AND</span> ?<span class="pl-k">+</span>?            |
| <span class="pl-c1">1</span>  | <span class="pl-c1">4447573</span>  | <span class="pl-c1">8567</span>       | <span class="pl-k">SELECT</span> <span class="pl-c1">SUM</span>(K) <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id BETWEEN ? <span class="pl-k">AND</span> ?<span class="pl-k">+</span>?       |
| <span class="pl-c1">1</span>  | <span class="pl-c1">4040300</span>  | <span class="pl-c1">8567</span>       | <span class="pl-k">UPDATE</span> sbtest1 <span class="pl-k">SET</span> c<span class="pl-k">=</span>? <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>?                           |
| <span class="pl-c1">1</span>  | <span class="pl-c1">3378990</span>  | <span class="pl-c1">8567</span>       | <span class="pl-k">DELETE</span> <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>?                              |
| <span class="pl-c1">1</span>  | <span class="pl-c1">3046664</span>  | <span class="pl-c1">8567</span>       | <span class="pl-k">INSERT INTO</span> sbtest1 (id, k, c, pad) <span class="pl-k">VALUES</span> (?, ?, ?, ?)     |
| <span class="pl-c1">1</span>  | <span class="pl-c1">2974559</span>  | <span class="pl-c1">8596</span>       | <span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>?                            |
| <span class="pl-c1">2</span>  | <span class="pl-c1">2805758</span>  | <span class="pl-c1">2376</span>       | <span class="pl-k">SELECT DISTINCT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id BETWEEN ? <span class="pl-k">AND</span> ?<span class="pl-k">+</span>?   |
| <span class="pl-c1">1</span>  | <span class="pl-c1">2480409</span>  | <span class="pl-c1">8567</span>       | <span class="pl-k">BEGIN</span>                                                       |
| <span class="pl-c1">1</span>  | <span class="pl-c1">1152803</span>  | <span class="pl-c1">2579</span>       | <span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest2 <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>?                            |
| <span class="pl-k">-</span><span class="pl-c1">1</span> | <span class="pl-c1">0</span>        | <span class="pl-c1">6191</span>       | <span class="pl-k">SELECT DISTINCT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id BETWEEN ? <span class="pl-k">AND</span> ?<span class="pl-k">+</span>?   |
| <span class="pl-k">-</span><span class="pl-c1">1</span> | <span class="pl-c1">0</span>        | <span class="pl-c1">74495</span>      | <span class="pl-k">SELECT</span> c <span class="pl-k">FROM</span> sbtest1 <span class="pl-k">WHERE</span> id<span class="pl-k">=</span>?                            |
<span class="pl-k">+</span><span class="pl-c"><span class="pl-c">--</span>--+----------+------------+-------------------------------------------------------------+</span>
<span class="pl-c1">14</span> rows <span class="pl-k">in</span> <span class="pl-k">set</span> (<span class="pl-c1">0</span>.<span class="pl-c1">01</span> sec)</pre></div>

        </div>

    </div>]